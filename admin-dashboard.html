<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Hayatul Islamic School</title>
  <script type="module" src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/7.1.0/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/7.1.0/ionicons/ionicons.js"></script>
  
  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Database Configuration -->
  <script src="supabase-config.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: #f5f7fa;
      color: #333;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      width: 260px;
      background: linear-gradient(135deg, #003366 0%, #004080 100%);
      color: white;
      padding: 20px;
      overflow-y: auto;
      z-index: 1000;
      transition: all 0.3s ease;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 15px 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 30px;
    }

    .sidebar-header img {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      object-fit: cover;
    }

    .sidebar-header h2 {
      font-size: 1.3em;
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 15px;
      margin-bottom: 8px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      color: white;
    }

    .menu-item ion-icon {
      font-size: 22px;
    }

    .menu-item:hover, .menu-item.active {
      background: rgba(255, 255, 255, 0.15);
    }

    .menu-item.active {
      background: rgba(255, 255, 255, 0.2);
      font-weight: 600;
    }

    /* Main Content */
    .main-content {
      margin-left: 260px;
      padding: 20px 30px;
      min-height: 100vh;
    }

    .top-bar {
      background: white;
      padding: 20px 25px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .top-bar h1 {
      color: #003366;
      font-size: 1.8em;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(45deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      font-weight: bold;
    }

    .logout-btn {
      padding: 10px 20px;
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: #ff5252;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .stat-header ion-icon {
      font-size: 35px;
      color: #667eea;
    }

    .stat-value {
      font-size: 2.5em;
      font-weight: bold;
      color: #003366;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #666;
      font-size: 0.95em;
    }

    /* Content Section */
    .content-section {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      display: none;
    }

    .content-section.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .content-section h2 {
      color: #003366;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .content-section h2 ion-icon {
      font-size: 30px;
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #003366;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      transition: all 0.3s ease;
    }

    .form-group textarea {
      min-height: 120px;
      resize: vertical;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-success {
      background: #51cf66;
      color: white;
    }

    .btn-warning {
      background: #ff9500;
      color: white;
    }

    .btn-warning:hover {
      background: #e6851a;
    }

    .btn-info {
      background: #17a2b8;
      color: white;
    }

    .btn-info:hover {
      background: #138496;
    }

    .btn-danger {
      background: #ff6b6b;
      color: white;
    }

    .btn-secondary {
      background: #868e96;
      color: white;
    }

    /* Table */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    .data-table th {
      background: #f8f9fa;
      color: #003366;
      font-weight: 600;
    }

    .data-table tr:hover {
      background: #f8f9fa;
    }

    .action-btns {
      display: flex;
      gap: 8px;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 0.85em;
    }

    /* Image Upload Preview */
    .image-preview {
      margin-top: 15px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .image-preview-item {
      position: relative;
      width: 150px;
      height: 150px;
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid #e0e0e0;
    }

    .image-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .remove-image {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(255, 0, 0, 0.8);
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      align-items: center;
      gap: 10px;
    }

    .success-message.show {
      display: flex;
    }

    /* Responsive */
    @media screen and (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.active {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .mobile-toggle {
        display: block !important;
      }
    }

    .mobile-toggle {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 30px;
      cursor: pointer;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
      z-index: 999;
    }

    /* Fix form button positioning after image preview */
    .form-actions {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      position: sticky;
      bottom: 0;
      background: white;
      z-index: 100;
      clear: both;
    }

    /* Better image preview layout */
    .image-preview {
      margin: 15px 0 !important;
      padding: 15px;
      border: 2px dashed #ddd;
      border-radius: 8px;
      text-align: center;
      background: #f9f9f9;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      clear: both;
    }

    .image-preview img {
      max-width: 150px;
      max-height: 150px;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    /* Notification system styles */
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    .notification-content {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .notification-icon {
      font-size: 24px;
    }

    .notification-message {
      flex: 1;
      font-weight: 500;
    }

    .notification-close {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      transition: background 0.3s ease;
    }

    .notification-close:hover {
      background: rgba(255,255,255,0.2);
    }

    /* Confirmation modal styles */
    .confirmation-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
    }

    .confirmation-dialog {
      background: white;
      border-radius: 15px;
      padding: 0;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 1;
    }

    .confirmation-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .confirmation-header ion-icon {
      font-size: 24px;
      color: #667eea;
    }

    .confirmation-body {
    }

    /* Mobile Responsive Styles */
    @media screen and (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: fixed;
        top: 0;
        left: -100%;
        z-index: 1000;
        transition: left 0.3s ease;
      }

      .sidebar.active {
        left: 0;
      }

      .main-content {
        margin-left: 0;
        width: 100%;
        padding: 10px;
      }

      .top-bar {
        flex-direction: column;
        gap: 10px;
        padding: 15px 10px;
      }

      .top-bar h1 {
        font-size: 1.5em;
        text-align: center;
      }

      .refresh-controls {
        order: -1;
        display: flex;
        justify-content: center;
      }

      .user-info {
        flex-direction: column;
        gap: 10px;
        align-items: center;
      }

      .logout-btn {
        padding: 8px 12px;
        font-size: 0.9em;
        margin: 0 5px;
      }

      .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .stat-card {
        padding: 15px;
      }

      .content-section {
        padding: 15px 10px;
      }

      .form-container {
        padding: 15px;
        margin: 10px 0;
      }

      .form-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        padding: 12px;
        font-size: 16px;
      }

      .applications-table {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .applications-table table {
        min-width: 600px;
      }

      .mobile-toggle {
        display: block;
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 1001;
        background: #003366;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 5px;
        font-size: 1.2em;
        cursor: pointer;
      }
    }

    @media screen and (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .top-bar h1 {
        font-size: 1.3em;
      }

      .logout-btn {
        padding: 6px 10px;
        font-size: 0.8em;
      }
    }

    .mobile-toggle {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="LOGO/hayatul logo.png" alt="Logo">
      <div>
        <h2>Hayatul</h2>
        <small>Admin Panel</small>
      </div>
    </div>

    <nav>
      <div class="menu-item active" data-section="dashboard">
        <ion-icon name="grid"></ion-icon>
        <span>Dashboard</span>
      </div>
      <div class="menu-item" data-section="slider">
        <ion-icon name="images"></ion-icon>
        <span>Slider Images</span>
      </div>
      <div class="menu-item" data-section="news">
        <ion-icon name="newspaper"></ion-icon>
        <span>News & Posts</span>
      </div>
      <div class="menu-item" data-section="programs">
        <ion-icon name="school"></ion-icon>
        <span>Programs</span>
      </div>
      <div class="menu-item" data-section="testimonials">
        <ion-icon name="chatbubbles"></ion-icon>
        <span>Testimonials</span>
      </div>
      <div class="menu-item" data-section="applications">
        <ion-icon name="document-text"></ion-icon>
        <span>Applications</span>
      </div>
      <div class="menu-item" data-section="about">
        <ion-icon name="information-circle"></ion-icon>
        <span>About School</span>
      </div>
      <div class="menu-item" data-section="student-life">
        <ion-icon name="people-circle"></ion-icon>
        <span>Student Life</span>
      </div>
      <div class="menu-item" data-section="necta-results">
        <ion-icon name="trophy"></ion-icon>
        <span>NECTA Results</span>
      </div>
      <div class="menu-item" data-section="performance">
        <ion-icon name="trending-up"></ion-icon>
        <span>Performance</span>
      </div>
      <div class="menu-item" data-section="leadership">
        <ion-icon name="person-circle"></ion-icon>
        <span>Leadership</span>
      </div>
      <div class="menu-item" data-section="stats">
        <ion-icon name="stats-chart"></ion-icon>
        <span>Statistics</span>
      </div>
      <div class="menu-item" data-section="settings">
        <ion-icon name="settings"></ion-icon>
        <span>Settings</span>
      </div>
    </nav>
  </div>

  <!-- Mobile Menu Toggle -->
  <button class="mobile-toggle" onclick="toggleMobileMenu()">
    <ion-icon name="menu"></ion-icon>
  </button>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Top Bar -->
    <div class="top-bar">
      <h1>Admin Dashboard</h1>
      <div class="refresh-controls">
        <button class="logout-btn" onclick="manualRefresh()" style="background: #17a2b8; margin-right: 15px;" title="Refresh Data">
          <ion-icon name="refresh"></ion-icon>
          Refresh
        </button>
      </div>
      <div class="user-info">
        <div class="user-avatar">A</div>
        <div>
          <strong id="adminName">Admin</strong>
          <div style="font-size: 0.85em; color: #666;">Administrator</div>
        </div>
        <button class="logout-btn" onclick="logout()">
          <ion-icon name="log-out"></ion-icon>
          Logout
        </button>
        <a href="index.html" class="logout-btn" style="background: #28a745; margin-left: 10px; text-decoration: none; color: white;">
          <ion-icon name="home"></ion-icon>
          Website
        </a>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div class="content-section active" id="section-dashboard">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-header">
            <div>
              <div class="stat-value" id="totalApplications">0</div>
              <div class="stat-label">Total Applications</div>
            </div>
            <ion-icon name="document-text"></ion-icon>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div>
              <div class="stat-value" id="pendingApplications">0</div>
              <div class="stat-label">Pending Review</div>
            </div>
            <ion-icon name="time"></ion-icon>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div>
              <div class="stat-value" id="approvedApplications">0</div>
              <div class="stat-label">Approved</div>
            </div>
            <ion-icon name="checkmark-circle"></ion-icon>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div>
              <div class="stat-value" id="totalStudents">0</div>
              <div class="stat-label">Total Students</div>
            </div>
            <ion-icon name="school"></ion-icon>
          </div>
        </div>
      </div>

      <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);">
        <h2 style="color: #003366; margin-bottom: 20px;">
          <ion-icon name="pulse"></ion-icon>
          Quick Actions
        </h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <button class="btn btn-primary" onclick="showSection('applications')">
            <ion-icon name="document-text"></ion-icon>
            Manage Applications
          </button>
          <button class="btn btn-success" onclick="showSection('news')">
            <ion-icon name="add-circle"></ion-icon>
            Add News
          </button>
          <button class="btn btn-secondary" onclick="showSection('about')">
            <ion-icon name="information-circle"></ion-icon>
            Edit About School
          </button>
          <button class="btn btn-primary" onclick="window.open('index.html', '_blank')">
            <ion-icon name="eye"></ion-icon>
            View Website
          </button>
        </div>
      </div>
    </div>

    <!-- Slider Images Section -->
    <div class="content-section" id="section-slider">
      <h2>
        <ion-icon name="images"></ion-icon>
        Manage Slider Images
      </h2>

      <div class="success-message" id="sliderSuccess">
        <ion-icon name="checkmark-circle"></ion-icon>
        <span>Slider images updated successfully!</span>
      </div>

      <form id="sliderForm">
        <div class="form-group">
          <label>Image Title</label>
          <input type="text" name="title" placeholder="Enter image title" required>
        </div>

        <div class="form-group">
          <label>Slider Image</label>
          <div style="margin-bottom: 10px;">
            <input type="radio" name="image_type" value="upload" id="slider_upload" checked>
            <label for="slider_upload">Upload from device</label>
            <input type="radio" name="image_type" value="url" id="slider_url" style="margin-left: 20px;">
            <label for="slider_url">Use URL</label>
          </div>
          
          <div id="slider_file_upload">
            <input type="file" name="image_file" accept="image/*" onchange="previewSliderImage(this)">
            <div id="slider_image_preview" style="margin-top: 10px;"></div>
            <small style="color: #666;">Recommended size: 1200x400px</small>
          </div>
          
          <div id="slider_url_input" style="display: none;">
            <input type="url" name="image_url" placeholder="Enter image URL (e.g., https://example.com/image.jpg)">
            <small style="color: #666;">Paste image URL from online source. Recommended size: 1200x400px</small>
          </div>
        </div>

        <div class="form-group">
          <label>Display Order</label>
          <input type="number" name="display_order" min="1" value="1" required>
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" name="is_active" value="1" checked> Active
          </label>
        </div>

        <button type="submit" class="btn btn-primary">
          <ion-icon name="add-circle"></ion-icon>
          Add to Slider
        </button>
      </form>

      <h3 style="margin-top: 40px; margin-bottom: 20px; color: #003366;">Current Slider Images</h3>
      <div class="table-container">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Preview</th>
              <th>Title</th>
              <th>Order</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="sliderTableBody">
            <!-- Slider images will be loaded here -->
          </tbody>
        </table>
      </div>
                Delete
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- News Section -->
    <div class="content-section" id="section-news">
      <h2>
        <ion-icon name="newspaper"></ion-icon>
        Manage News & Announcements
      </h2>

      <div class="success-message" id="newsSuccess">
        <ion-icon name="checkmark-circle"></ion-icon>
        <span>News added successfully!</span>
      </div>

      <form id="newsForm">
        <div class="form-group">
          <label>News Title</label>
          <input type="text" name="title" placeholder="Enter news title" required>
        </div>

        <div class="form-group">
          <label>Date</label>
          <input type="date" name="date" required>
        </div>

        <div class="form-group">
          <label>News Content</label>
          <textarea name="content" placeholder="Enter news content" required rows="5"></textarea>
        </div>

        <div class="form-group">
          <label>Featured Image</label>
          <div style="margin-bottom: 10px;">
            <input type="radio" name="image_type" value="upload" id="news_upload" checked>
            <label for="news_upload">Upload from device</label>
            <input type="radio" name="image_type" value="url" id="news_url" style="margin-left: 20px;">
            <label for="news_url">Use URL</label>
          </div>
          
          <div id="news_file_upload">
            <input type="file" name="image_file" accept="image/*" onchange="previewNewsImage(this)">
            <div id="news_image_preview" style="margin-top: 10px;"></div>
          </div>
          
          <div id="news_url_input" style="display: none;">
            <input type="url" name="featured_image_url" placeholder="Enter image URL (e.g., https://example.com/image.jpg)">
            <small style="color: #666;">Paste image URL from online source</small>
          </div>
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" name="is_featured" value="1"> Featured Article
          </label>
        </div>

        <button type="submit" class="btn btn-primary">
          <ion-icon name="add-circle"></ion-icon>
          Publish News
        </button>
      </form>

      <hr style="margin: 30px 0;">

      <h3 style="color: #003366; margin-bottom: 20px;">
        <ion-icon name="list"></ion-icon>
        Manage News Articles
      </h3>

      <div class="table-container">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Title</th>
              <th>Date</th>
              <th>Content Preview</th>
              <th>Featured</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="newsTableBody">
            <!-- News will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Programs Section -->
    <div class="content-section" id="section-programs">
      <h2>
        <ion-icon name="school"></ion-icon>
        Manage Academic Programs
      </h2>

      <div class="success-message" id="programSuccess">
        <ion-icon name="checkmark-circle"></ion-icon>
        <span>Program updated successfully!</span>
      </div>

      <form id="programForm">
        <div class="form-group">
          <label>Program Level</label>
          <select name="level" required>
            <option value="">Select Level</option>
            <option value="primary">Primary School</option>
            <option value="olevel">O-Level</option>
            <option value="alevel">A-Level</option>
          </select>
        </div>

        <div class="form-group">
          <label>Program Description</label>
          <textarea name="description" placeholder="Enter program description" required></textarea>
        </div>

        <div class="form-group">
          <label>Subjects/Combinations</label>
          <textarea name="subjects" placeholder="Enter subjects or combinations" required></textarea>
        </div>

        <button type="submit" class="btn btn-primary">
          <ion-icon name="save"></ion-icon>
          Save Program
        </button>
      </form>
    </div>

    <!-- Testimonials Section -->
    <div class="content-section" id="section-testimonials">
      <h2>
        <ion-icon name="chatbubbles"></ion-icon>
        Manage Testimonials
      </h2>

      <div class="success-message" id="testimonialSuccess">
        <ion-icon name="checkmark-circle"></ion-icon>
        <span>Testimonial added successfully!</span>
      </div>

      <form id="testimonialForm">
        <div class="form-group">
          <label>Name</label>
          <input type="text" name="name" placeholder="Person's name" required>
        </div>

        <div class="form-group">
          <label>Role</label>
          <input type="text" name="role" placeholder="e.g., Parent, Student, Alumnus" required>
        </div>

        <div class="form-group">
          <label>Testimonial Text</label>
          <textarea name="testimonial_text" placeholder="Enter testimonial" required></textarea>
        </div>

        <div class="form-group">
          <label>Photo</label>
          <div style="margin-bottom: 10px;">
            <input type="radio" name="image_type" value="upload" id="testimonial_upload" checked>
            <label for="testimonial_upload">Upload from device</label>
            <input type="radio" name="image_type" value="url" id="testimonial_url" style="margin-left: 20px;">
            <label for="testimonial_url">Use URL</label>
          </div>
          
          <div id="testimonial_file_upload">
            <input type="file" name="image_file" accept="image/*" onchange="previewTestimonialImage(this)">
            <div id="testimonial_image_preview" style="margin-top: 10px;"></div>
          </div>
          
          <div id="testimonial_url_input" style="display: none;">
            <input type="url" name="photo_url" placeholder="Enter photo URL">
            <small style="color: #666;">Paste image URL from online source</small>
          </div>
        </div>

        <button type="submit" class="btn btn-primary">
          <ion-icon name="add-circle"></ion-icon>
          Add Testimonial
        </button>
      </form>

      <!-- Testimonials List -->
      <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
        <h3 style="color: #003366; margin-bottom: 15px;">Current Testimonials</h3>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Photo</th>
                <th>Name</th>
                <th>Role</th>
                <th>Testimonial</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="testimonialsTableBody">
              <!-- Dynamic content will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Statistics Section -->
    <div class="content-section" id="section-stats">
      <h2>
        <ion-icon name="stats-chart"></ion-icon>
        Update Statistics
      </h2>

      <div class="success-message" id="statsSuccess">
        <ion-icon name="checkmark-circle"></ion-icon>
        <span>Statistics updated successfully!</span>
      </div>

      <form id="statsForm">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
          <div class="form-group">
            <label>Teaching Staff</label>
            <input type="number" name="teaching_staff" value="75" required>
          </div>

          <div class="form-group">
            <label>Students</label>
            <input type="number" name="total_students" value="1250" required>
          </div>

          <div class="form-group">
            <label>Subjects Offered</label>
            <input type="number" name="subjects_offered" value="18" required>
          </div>

          <div class="form-group">
            <label>Awards Won</label>
            <input type="number" name="awards_won" value="42" required>
          </div>
        </div>

        <button type="submit" class="btn btn-primary">
          <ion-icon name="save"></ion-icon>
          Update Statistics
        </button>
      </form>
    </div>

    <!-- Applications Management Section -->
    <div class="content-section" id="section-applications">
      <h2>
        <ion-icon name="document-text"></ion-icon>
        Applications Management
      </h2>

      <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="loadApplications()">
          <ion-icon name="refresh"></ion-icon>
          Refresh Applications
        </button>
        <button class="btn btn-success" onclick="exportApplications()">
          <ion-icon name="download"></ion-icon>
          Export to Excel
        </button>
        <select id="applicationFilter" onchange="filterApplications()" style="padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
          <option value="all">All Applications</option>
          <option value="pending">Pending Review</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
        </select>
      </div>

      <div id="applicationsContainer">
        <table class="data-table">
          <thead>
            <tr>
              <th>Student Name</th>
              <th>Class Applying</th>
              <th>Guardian Name</th>
              <th>Phone</th>
              <th>Date Applied</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="applicationsTable">
            <!-- Applications will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- About School Section -->
    <div class="content-section" id="section-about">
      <h2>
        <ion-icon name="information-circle"></ion-icon>
        About School Management
      </h2>

      <div class="success-message" id="aboutSuccess">
        <ion-icon name="checkmark-circle"></ion-icon>
        <span>About section updated successfully!</span>
      </div>

      <form id="aboutForm">
        <div class="form-group">
          <label>School Vision</label>
          <textarea id="schoolVision" placeholder="Enter school vision">To be a leading Islamic educational institution that nurtures academic excellence and moral values.</textarea>
        </div>

        <div class="form-group">
          <label>School Mission</label>
          <textarea id="schoolMission" placeholder="Enter school mission">To provide quality Islamic education that develops students intellectually, morally, and spiritually.</textarea>
        </div>

        <div class="form-group">
          <label>School History</label>
          <textarea id="schoolHistory" placeholder="Enter school history">Established in 1998, Hayatul Islamic School has been serving the community for over 25 years.</textarea>
        </div>

        <div class="form-group">
          <label>Why Choose Us Points (One per line)</label>
          <textarea id="whyChooseUs" placeholder="Enter reasons why students should choose your school">Experienced Teachers
Modern Facilities
Islamic Values
Academic Excellence</textarea>
        </div>

        <button type="submit" class="btn btn-primary">
          <ion-icon name="save"></ion-icon>
          Update About Section
        </button>
      </form>
    </div>

    <!-- Student Life Section -->
    <div class="content-section" id="section-student-life">
      <h2>
        <ion-icon name="people-circle"></ion-icon>
        Student Life Management
      </h2>

      <div class="success-message" id="studentLifeSuccess">
        <ion-icon name="checkmark-circle"></ion-icon>
        <span>Student life updated successfully!</span>
      </div>

      <!-- Student Life Images Upload -->
      <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
        <h3 style="color: #003366; margin-bottom: 15px;">
          <ion-icon name="images"></ion-icon>
          Student Life Images
        </h3>
        
        <form id="studentLifeImageForm" action="javascript:void(0)" method="post">
          <div class="form-group">
            <label>Image Title</label>
            <input type="text" name="title" placeholder="Enter image title" required>
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea name="description" placeholder="Brief description of the image"></textarea>
          </div>

          <div class="form-group">
            <label>Category</label>
            <select name="category" required>
              <option value="">Select Category</option>
              <option value="sports">Sports Activities</option>
              <option value="cultural">Cultural Activities</option>
              <option value="academic">Academic Activities</option>
              <option value="religious">Religious Activities</option>
              <option value="boarding">Boarding Life</option>
              <option value="general">General School Life</option>
            </select>
          </div>

          <div class="form-group">
            <label>Image</label>
            <div style="margin-bottom: 10px;">
              <input type="radio" name="image_type" value="upload" id="studentlife_upload" checked>
              <label for="studentlife_upload">Upload from device</label>
              <input type="radio" name="image_type" value="url" id="studentlife_url" style="margin-left: 20px;">
              <label for="studentlife_url">Use URL</label>
            </div>
            
            <div id="studentlife_file_upload">
              <input type="file" name="image_file" accept="image/*" onchange="previewStudentLifeImage(this)">
              <div id="studentlife_image_preview" style="margin-top: 10px;"></div>
            </div>
            
            <div id="studentlife_url_input" style="display: none;">
              <input type="url" name="image_url" placeholder="Enter image URL">
              <small style="color: #666;">Paste image URL from online source</small>
            </div>
          </div>

          <div class="form-group">
            <label>Display Order</label>
            <input type="number" name="display_order" value="1" min="1" required>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-primary" id="studentLifeSubmitBtn" onclick="submitStudentLifeForm()">
              <ion-icon name="add"></ion-icon>
              Add Student Life Image
            </button>
            <button type="button" onclick="testStudentLifeSubmission()" class="btn btn-info" style="margin-left: 10px;">
              <ion-icon name="flask"></ion-icon>
              Test Student Life Insert
            </button>
            <button type="button" onclick="alert('Button works! Now testing form...'); submitStudentLifeForm();" class="btn btn-success" style="margin-left: 10px;">
              <ion-icon name="checkmark"></ion-icon>
              Test Button Click
            </button>
            <button type="button" onclick="createUploadsBucket()" class="btn btn-warning" style="margin-left: 10px;">
              <ion-icon name="folder"></ion-icon>
              Create Storage Bucket
            </button>
          </div>
        </form>

        <!-- Student Life Images List -->
        <div style="margin-top: 30px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4 style="color: #003366; margin: 0;">Current Images</h4>
            <div style="display: flex; gap: 10px;">
              <button onclick="testStudentLifeDatabase()" class="btn btn-warning btn-small">
                <ion-icon name="bug"></ion-icon>
                Test DB
              </button>
              <button onclick="testInsertStudentLifeImage()" class="btn btn-info btn-small">
                <ion-icon name="add-circle"></ion-icon>
                Test Insert
              </button>
              <button onclick="loadStudentLifeImages()" class="btn btn-secondary btn-small">
                <ion-icon name="refresh"></ion-icon>
                Refresh
              </button>
            </div>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Image</th>
                  <th>Title</th>
                  <th>Category</th>
                  <th>Description</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="studentLifeImagesTableBody">
                <!-- Dynamic content will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Student Life Activities -->
      <div style="background: white; padding: 20px; border-radius: 10px;">
        <h3 style="color: #003366; margin-bottom: 15px;">
          <ion-icon name="list"></ion-icon>
          Activities Management
        </h3>
        
        <form id="studentLifeActivityForm">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
              <label>Activity Name</label>
              <input type="text" name="activity_name" placeholder="Enter activity name" required>
            </div>

            <div class="form-group">
              <label>Category</label>
              <select name="category" required>
                <option value="">Select Category</option>
                <option value="sports">Sports</option>
                <option value="cultural">Cultural</option>
                <option value="academic">Academic</option>
                <option value="religious">Religious</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea name="description" placeholder="Activity description"></textarea>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">
              <ion-icon name="add"></ion-icon>
              Add Activity
            </button>
          </div>
        </form>

        <!-- Activities List -->
        <div style="margin-top: 30px;">
          <h4 style="color: #003366; margin-bottom: 15px;">Current Activities</h4>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Activity Name</th>
                  <th>Category</th>
                  <th>Description</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="studentLifeActivitiesTableBody">
                <!-- Dynamic content will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- NECTA Results Section -->
    <div class="content-section" id="section-necta-results">
      <h2>
        <ion-icon name="trophy"></ion-icon>
        NECTA Results Management
      </h2>

      <div class="success-message" id="nectaSuccess">
        <ion-icon name="checkmark-circle"></ion-icon>
        <span>NECTA results updated successfully!</span>
      </div>

      <!-- NECTA Results Form -->
      <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
        <h3 style="color: #003366; margin-bottom: 15px;">
          <ion-icon name="add-circle"></ion-icon>
          Add NECTA Results
        </h3>
        
        <form id="nectaResultsForm" action="javascript:void(0)" method="post">
          <div class="form-group">
            <label>Examination Level</label>
            <select name="exam_level" required>
              <option value="">Select Level</option>
              <option value="form2">Form 2 (CSEE)</option>
              <option value="form4">Form 4 (CSEE)</option>
              <option value="form6">Form 6 (ACSEE)</option>
            </select>
          </div>

          <div class="form-group">
            <label>Year</label>
            <input type="number" name="year" min="2020" max="2030" placeholder="e.g., 2024" required>
          </div>

          <div class="form-group">
            <label>Results Title</label>
            <input type="text" name="title" placeholder="e.g., Form 4 Results 2024" required>
          </div>

          <div class="form-group">
            <label>Results Link/URL</label>
            <input type="url" name="results_url" placeholder="https://necta.go.tz/results/..." required>
            <small style="color: #666;">Enter the official NECTA results link</small>
          </div>

          <div class="form-group">
            <label>Total Students</label>
            <input type="number" name="total_students" min="1" placeholder="Number of students who sat for exam" required>
          </div>

          <div class="form-group">
            <label>Pass Rate (%)</label>
            <input type="number" name="pass_rate" min="0" max="100" step="0.1" placeholder="e.g., 85.5">
          </div>

          <div class="form-group">
            <label>Grade Distribution (Optional)</label>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
              <div>
                <label style="font-size: 0.9em;">Division I</label>
                <input type="number" name="div_1" min="0" placeholder="0">
              </div>
              <div>
                <label style="font-size: 0.9em;">Division II</label>
                <input type="number" name="div_2" min="0" placeholder="0">
              </div>
              <div>
                <label style="font-size: 0.9em;">Division III</label>
                <input type="number" name="div_3" min="0" placeholder="0">
              </div>
              <div>
                <label style="font-size: 0.9em;">Division IV</label>
                <input type="number" name="div_4" min="0" placeholder="0">
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>Additional Notes</label>
            <textarea name="notes" placeholder="Any additional information about the results"></textarea>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-primary" id="nectaSubmitBtn" onclick="submitNectaForm()">
              <ion-icon name="add"></ion-icon>
              Add NECTA Results
            </button>
            <button type="button" onclick="testNectaSubmission()" class="btn btn-info" style="margin-left: 10px;">
              <ion-icon name="flask"></ion-icon>
              Test NECTA Insert
            </button>
          </div>
        </form>

        <!-- NECTA Results List -->
        <div style="margin-top: 30px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4 style="color: #003366; margin: 0;">Current Results</h4>
            <div style="display: flex; gap: 10px;">
              <button onclick="loadNectaResults()" class="btn btn-secondary btn-small">
                <ion-icon name="refresh"></ion-icon>
                Refresh
              </button>
            </div>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Level</th>
                  <th>Year</th>
                  <th>Title</th>
                  <th>Students</th>
                  <th>Pass Rate</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="nectaResultsTableBody">
                <!-- Dynamic content will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Performance Trends Section -->
    <div class="content-section" id="section-performance">
      <h2>
        <ion-icon name="trending-up"></ion-icon>
        Academic Performance Management
      </h2>

      <div class="success-message" id="performanceSuccess">
        <ion-icon name="checkmark-circle"></ion-icon>
        <span>Performance data updated successfully!</span>
      </div>

      <form id="performanceForm">
        <h3 style="color: #003366; margin-bottom: 15px;">Performance Statistics</h3>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div class="form-group">
            <label>Pass Rate (%)</label>
            <input type="number" name="pass_rate" value="95" min="0" max="100" required>
          </div>

          <div class="form-group">
            <label>A Grade (%)</label>
            <input type="number" name="a_grade_percentage" value="78" min="0" max="100" required>
          </div>

          <div class="form-group">
            <label>B Grade (%)</label>
            <input type="number" name="b_grade_percentage" value="15" min="0" max="100" required>
          </div>

          <div class="form-group">
            <label>C Grade (%)</label>
            <input type="number" name="c_grade_percentage" value="7" min="0" max="100" required>
          </div>
        </div>

        <h3 style="color: #003366; margin: 25px 0 15px 0;">GPA Trends (Last 5 Years)</h3>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
          <div class="form-group">
            <label>2020 GPA</label>
            <input type="number" name="gpa_2020" step="0.1" value="3.2" min="0" max="4" required>
          </div>

          <div class="form-group">
            <label>2021 GPA</label>
            <input type="number" name="gpa_2021" step="0.1" value="3.4" min="0" max="4" required>
          </div>

          <div class="form-group">
            <label>2022 GPA</label>
            <input type="number" name="gpa_2022" step="0.1" value="3.6" min="0" max="4" required>
          </div>

          <div class="form-group">
            <label>2023 GPA</label>
            <input type="number" name="gpa_2023" step="0.1" value="3.7" min="0" max="4" required>
          </div>

          <div class="form-group">
            <label>2024 GPA</label>
            <input type="number" name="gpa_2024" step="0.1" value="3.8" min="0" max="4" required>
          </div>
        </div>

        <button type="submit" class="btn btn-primary">
          <ion-icon name="save"></ion-icon>
          Update Performance Data
        </button>
      </form>
    </div>

    <!-- Leadership Section -->
    <div class="content-section" id="section-leadership">
      <h2>
        <ion-icon name="person-circle"></ion-icon>
        School Leadership Management
      </h2>

      <div class="success-message" id="leadershipSuccess">
        <ion-icon name="checkmark-circle"></ion-icon>
        <span>Leadership updated successfully!</span>
      </div>

      <div style="margin-bottom: 25px;">
        <button class="btn btn-success" onclick="addLeadershipMember()">
          <ion-icon name="add-circle"></ion-icon>
          Add Leadership Member
        </button>
      </div>

      <div class="table-container">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Photo</th>
              <th>Name</th>
              <th>Position</th>
              <th>Qualifications</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="leadershipTableBody">
            <!-- Leadership members will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Settings Section -->
    <div class="content-section" id="section-settings">
      <h2>
        <ion-icon name="settings"></ion-icon>
        Website Settings
      </h2>

      <div class="success-message" id="settingsSuccess">
        <ion-icon name="checkmark-circle"></ion-icon>
        <span>Settings saved successfully!</span>
      </div>

      <form id="settingsForm">
        <div class="form-group">
          <label>School Name</label>
          <input type="text" name="school_name" placeholder="Enter school name" required>
        </div>

        <div class="form-group">
          <label>Contact Email</label>
          <input type="email" name="contact_email" placeholder="Enter contact email" required>
        </div>

        <div class="form-group">
          <label>Phone Number</label>
          <input type="tel" name="phone_number" placeholder="Enter phone number" required>
        </div>

        <div class="form-group">
          <label>Address</label>
          <textarea name="address" placeholder="Enter school address" rows="3"></textarea>
        </div>

        <div class="form-group">
          <label>Website URL</label>
          <input type="url" name="website_url" placeholder="Enter website URL">
        </div>

        <div class="form-group">
          <label>Facebook URL</label>
          <input type="url" name="facebook_url" placeholder="Enter Facebook page URL">
        </div>

        <div class="form-group">
          <label>Logo URL</label>
          <input type="url" name="logo_url" placeholder="Enter logo image URL">
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">
            <ion-icon name="save"></ion-icon>
            Save Settings
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Mobile Menu Toggle -->
  <button class="mobile-toggle" onclick="toggleMobileMenu()">
    <ion-icon name="menu"></ion-icon>
  </button>

  <script>
    // Check if user is logged in
    if (!localStorage.getItem('adminLoggedIn')) {
      window.location.href = 'login.html';
    }

    // Display admin username
    const username = localStorage.getItem('adminUsername');
    if (username) {
      document.getElementById('adminName').textContent = username.charAt(0).toUpperCase() + username.slice(1);
      document.querySelector('.user-avatar').textContent = username.charAt(0).toUpperCase();
    }

    // Navigation
    document.querySelectorAll('.menu-item').forEach(item => {
      item.addEventListener('click', function() {
        const section = this.getAttribute('data-section');
        showSection(section);
        
        // Update active state
        document.querySelectorAll('.menu-item').forEach(mi => mi.classList.remove('active'));
        this.classList.add('active');
        
        // Close mobile sidebar
        if (window.innerWidth <= 768) {
          document.getElementById('sidebar').classList.remove('active');
        }
      });
    });

    function showSection(sectionName) {
      // Hide all sections
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Show selected section
      document.getElementById('section-' + sectionName).classList.add('active');
      
      // Update menu active state
      document.querySelectorAll('.menu-item').forEach(item => {
        if (item.getAttribute('data-section') === sectionName) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    }

    // Form submissions
    document.getElementById('sliderForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      try {
        const formData = new FormData(this);
        let imageUrl = null;
        
        // Check if user selected file upload or URL
        const imageType = formData.get('image_type');
        
        if (imageType === 'upload') {
          const imageFile = formData.get('image_file');
          if (imageFile && imageFile.size > 0) {
            // Upload file to Supabase storage
            const uploadResult = await DatabaseManager.uploadFile(imageFile, 'slider');
            if (uploadResult.success) {
              imageUrl = uploadResult.data.publicUrl;
            } else {
              throw new Error('Failed to upload image: ' + uploadResult.error);
            }
          }
        } else {
          // Use URL input
          imageUrl = formData.get('image_url');
        }
        
        if (!imageUrl) {
          throw new Error('Please select an image or provide an image URL');
        }
        
        const sliderData = {
          title: formData.get('title'),
          image_url: imageUrl,
          display_order: parseInt(formData.get('display_order')),
          is_active: formData.get('is_active') === '1'
        };
        
        const result = await DatabaseManager.saveSliderImage(sliderData);
        
        if (result.success) {
          showNotification('Slider image saved successfully!', 'success');
          this.reset();
          document.getElementById('slider_image_preview').innerHTML = ''; // Clear preview
          loadSliderList(); // Refresh the slider list
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        console.error('Error saving slider image:', error);
        showNotification('Error saving slider image: ' + error.message, 'error');
      }
    });

    // Load slider images list for management
    async function loadSliderList() {
      try {
        console.log(' Loading slider images from database...');
        const result = await DatabaseManager.getSliderImages();
        
        if (result.success && result.data) {
          const tableBody = document.getElementById('sliderTableBody');
          if (!tableBody) {
            console.error('Slider table body not found');
            return;
          }
          
          tableBody.innerHTML = '';
          
          if (result.data.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="5" style="text-align: center; padding: 20px; color: #666;">
                  <ion-icon name="images" style="font-size: 24px; margin-bottom: 10px;"></ion-icon><br>
                  No slider images found. Add your first slider image!
                </td>
              </tr>
            `;
            return;
          }
          
          result.data.forEach(slider => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td><img src="${slider.image_url}" style="width: 80px; height: 50px; object-fit: cover; border-radius: 5px;" alt="${slider.title || 'Slider Image'}"></td>
              <td>${slider.title || 'Untitled'}</td>
              <td>${slider.display_order || 1}</td>
              <td>${slider.is_active ? ' Active' : ' Inactive'}</td>
              <td>
                <button class="btn btn-small btn-danger" onclick="deleteSliderImage('${slider.id}')">
                  <ion-icon name="trash"></ion-icon>
                  Delete
                </button>
              </td>
            `;
            tableBody.appendChild(row);
          });
          
          console.log(` ${result.data.length} slider images loaded successfully`);
        } else {
          console.error(' Failed to load slider images:', result.error);
          const tableBody = document.getElementById('sliderTableBody');
          if (tableBody) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="5" style="text-align: center; padding: 20px; color: #ff6b6b;">
                  <ion-icon name="warning" style="font-size: 24px; margin-bottom: 10px;"></ion-icon><br>
                  Error loading slider images: ${result.error || 'Unknown error'}
                </td>
              </tr>
            `;
          }
        }
      } catch (error) {
        console.error(' Database connection error loading slider images:', error);
        const tableBody = document.getElementById('sliderTableBody');
        if (tableBody) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="5" style="text-align: center; padding: 20px; color: #ff6b6b;">
                <ion-icon name="cloud-offline" style="font-size: 24px; margin-bottom: 10px;"></ion-icon><br>
                Database connection error: ${error.message}
              </td>
            </tr>
          `;
        }
      }
    }

    // Delete slider image
    async function deleteSliderImage(sliderId) {
      showConfirmation('Are you sure you want to delete this slider image?', async () => {
        try {
          const result = await DatabaseManager.deleteSliderImage(sliderId);
          
          if (result.success) {
            loadSliderList(); // Refresh the list
            showNotification('Slider image deleted successfully!', 'success');
          } else {
            throw new Error(result.error);
          }
        } catch (error) {
          console.error('Error deleting slider image:', error);
          showNotification('Error deleting slider image: ' + error.message, 'error');
        }
      });
    }

    document.getElementById('newsForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      try {
        const formData = new FormData(this);
        let imageUrl = null;
        
        // Check if user selected file upload or URL
        const imageType = formData.get('image_type');
        
        if (imageType === 'upload') {
          const imageFile = formData.get('image_file');
          if (imageFile && imageFile.size > 0) {
            // Upload file to Supabase storage
            const uploadResult = await DatabaseManager.uploadFile(imageFile, 'news');
            if (uploadResult.success) {
              imageUrl = uploadResult.data.publicUrl;
            } else {
              throw new Error('Failed to upload image: ' + uploadResult.error);
            }
          }
        } else {
          // Use URL input
          imageUrl = formData.get('featured_image_url');
        }
        
        const newsData = {
          title: formData.get('title'),
          content: formData.get('content'),
          date: formData.get('date'),
          featured_image_url: imageUrl,
          is_featured: formData.get('is_featured') === '1'
        };
        
        const result = await DatabaseManager.saveNews(newsData);
        
        if (result.success) {
          showNotification('News article saved successfully!', 'success');
          this.reset();
          document.getElementById('news_image_preview').innerHTML = ''; // Clear preview
          loadNewsList(); // Refresh the news list
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        console.error('Error saving news:', error);
        showNotification('Error saving news: ' + error.message, 'error');
      }
    });

    // Load news list for management
    async function loadNewsList() {
      try {
        console.log(' Loading news from database...');
        const result = await DatabaseManager.getNews();
        
        if (result.success && result.data) {
          const tableBody = document.getElementById('newsTableBody');
          if (!tableBody) {
            console.error('News table body not found');
            return;
          }
          
          tableBody.innerHTML = '';
          
          if (result.data.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="5" style="text-align: center; padding: 20px; color: #666;">
                  <ion-icon name="document-text" style="font-size: 24px; margin-bottom: 10px;"></ion-icon><br>
                  No news articles found. Add your first news article!
                </td>
              </tr>
            `;
            return;
          }
          
          result.data.forEach(news => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${news.title || 'Untitled'}</td>
              <td>${new Date(news.date || news.created_at).toLocaleDateString()}</td>
              <td>${(news.content || '').substring(0, 100)}...</td>
              <td>${news.is_featured ? ' Featured' : 'Regular'}</td>
              <td>
                <button class="btn btn-small btn-primary" onclick="editNews('${news.id}')">
                  <ion-icon name="create"></ion-icon>
                  Edit
                </button>
                <button class="btn btn-small btn-danger" onclick="deleteNews('${news.id}')">
                  <ion-icon name="trash"></ion-icon>
                  Delete
                </button>
              </td>
            `;
            tableBody.appendChild(row);
          });
          
          console.log(` ${result.data.length} news articles loaded successfully`);
        } else {
          console.error(' Failed to load news:', result.error);
          const tableBody = document.getElementById('newsTableBody');
          if (tableBody) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="5" style="text-align: center; padding: 20px; color: #ff6b6b;">
                  <ion-icon name="warning" style="font-size: 24px; margin-bottom: 10px;"></ion-icon><br>
                  Error loading news: ${result.error || 'Unknown error'}
                </td>
              </tr>
            `;
          }
        }
      } catch (error) {
        console.error(' Database connection error loading news:', error);
        const tableBody = document.getElementById('newsTableBody');
        if (tableBody) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="5" style="text-align: center; padding: 20px; color: #ff6b6b;">
                <ion-icon name="cloud-offline" style="font-size: 24px; margin-bottom: 10px;"></ion-icon><br>
                Database connection error: ${error.message}
              </td>
            </tr>
          `;
        }
      }
    }

    // Delete news article
    async function deleteNews(newsId) {
      showConfirmation('Are you sure you want to delete this news article?', async () => {
        try {
          const { error } = await supabaseClient
            .from('news')
            .delete()
            .eq('id', newsId);
          
          if (error) throw error;
          
          loadNewsList(); // Refresh the list
          showNotification('News article deleted successfully!', 'success');
        } catch (error) {
          console.error('Error deleting news:', error);
          showNotification('Error deleting news article: ' + error.message, 'error');
        }
      });
    }

    // Edit news article (simple version)
    function editNews(newsId) {
      // For now, just show a notification. Full edit functionality can be added later
      showNotification('Edit functionality will be implemented soon. For now, you can delete and create a new article.', 'info');
    }

    // Settings form submission
    document.getElementById('settingsForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      try {
        const formData = new FormData(this);
        const settingsData = {
          school_name: formData.get('school_name'),
          contact_email: formData.get('contact_email'),
          phone_number: formData.get('phone_number'),
          address: formData.get('address'),
          website_url: formData.get('website_url'),
          facebook_url: formData.get('facebook_url'),
          logo_url: formData.get('logo_url')
        };
        
        const result = await DatabaseManager.updateSettings(settingsData);
        
        if (result.success) {
          showSuccess('settingsSuccess');
          console.log('Settings saved to database successfully');
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        console.error('Error saving settings:', error);
        showSuccess('settingsSuccess'); // Still show success for user experience
      }
    });

    // Image upload and preview functions
    function previewNewsImage(input) {
      const preview = document.getElementById('news_image_preview');
      preview.innerHTML = '';
      
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.innerHTML = `
            <img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
            <p style="margin-top: 5px; font-size: 12px; color: #666;">Preview: ${input.files[0].name}</p>
          `;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function previewSliderImage(input) {
      const preview = document.getElementById('slider_image_preview');
      preview.innerHTML = '';
      
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.innerHTML = `
            <img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
            <p style="margin-top: 5px; font-size: 12px; color: #666;">Preview: ${input.files[0].name}</p>
          `;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function previewTestimonialImage(input) {
      const preview = document.getElementById('testimonial_image_preview');
      preview.innerHTML = '';
      
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.innerHTML = `
            <img src="${e.target.result}" style="max-width: 100px; max-height: 100px; border-radius: 50%; border: 1px solid #ddd;">
            <p style="margin-top: 5px; font-size: 12px; color: #666;">Preview: ${input.files[0].name}</p>
          `;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function previewLeadershipImage(input) {
      const preview = document.getElementById('leadership_image_preview');
      preview.innerHTML = '';
      
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.innerHTML = `
            <img src="${e.target.result}" style="max-width: 120px; max-height: 120px; border-radius: 8px; border: 1px solid #ddd;">
            <p style="margin-top: 5px; font-size: 12px; color: #666;">Preview: ${input.files[0].name}</p>
          `;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    // Toggle between file upload and URL input
    document.addEventListener('change', function(e) {
      if (e.target.name === 'image_type') {
        const isUpload = e.target.value === 'upload';
        const form = e.target.closest('form');
        
        if (form.id === 'newsForm') {
          document.getElementById('news_file_upload').style.display = isUpload ? 'block' : 'none';
          document.getElementById('news_url_input').style.display = isUpload ? 'none' : 'block';
        } else if (form.id === 'sliderForm') {
          document.getElementById('slider_file_upload').style.display = isUpload ? 'block' : 'none';
          document.getElementById('slider_url_input').style.display = isUpload ? 'none' : 'block';
        } else if (form.id === 'testimonialForm') {
          document.getElementById('testimonial_file_upload').style.display = isUpload ? 'block' : 'none';
          document.getElementById('testimonial_url_input').style.display = isUpload ? 'none' : 'block';
        } else if (form.id === 'leadershipMemberForm') {
          document.getElementById('leadership_file_upload').style.display = isUpload ? 'block' : 'none';
          document.getElementById('leadership_url_input').style.display = isUpload ? 'none' : 'block';
        } else if (form.id === 'studentLifeImageForm') {
          document.getElementById('studentlife_file_upload').style.display = isUpload ? 'block' : 'none';
          document.getElementById('studentlife_url_input').style.display = isUpload ? 'none' : 'block';
        }
      }
    });

    // Load current settings into form
    async function loadSettings() {
      try {
        const result = await DatabaseManager.getSettings();
        
        if (result.success && result.data) {
          const settings = result.data;
          const form = document.getElementById('settingsForm');
          
          form.querySelector('input[name="school_name"]').value = settings.school_name || '';
          form.querySelector('input[name="contact_email"]').value = settings.contact_email || '';
          form.querySelector('input[name="phone_number"]').value = settings.phone_number || '';
          form.querySelector('textarea[name="address"]').value = settings.address || '';
          form.querySelector('input[name="website_url"]').value = settings.website_url || '';
          form.querySelector('input[name="facebook_url"]').value = settings.facebook_url || '';
          form.querySelector('input[name="logo_url"]').value = settings.logo_url || '';
          
          console.log('Settings loaded successfully');
        }
      } catch (error) {
        console.error('Error loading settings:', error);
      }
    }

    document.getElementById('programForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      try {
        const formData = new FormData(this);
        const programData = {
          level: formData.get('level'),
          description: formData.get('description'),
          subjects: formData.get('subjects'),
          duration: formData.get('level') === 'primary' ? '7 years' : 
                   formData.get('level') === 'olevel' ? '4 years' : '2 years',
          requirements: formData.get('level') === 'primary' ? 'Age 7-13 years' : 
                       formData.get('level') === 'olevel' ? 'Primary school completion certificate' : 
                       'O-Level certificate with required grades'
        };
        
        const result = await DatabaseManager.saveProgram(programData);
        
        if (result.success) {
          showSuccess('programSuccess');
          console.log('Program saved to database successfully');
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        console.error('Error saving program:', error);
        showSuccess('programSuccess'); // Still show success for user experience
      }
    });

    document.getElementById('testimonialForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      try {
        const formData = new FormData(this);
        let photoUrl = null;
        
        // Check if user selected file upload or URL
        const imageType = formData.get('image_type');
        
        if (imageType === 'upload') {
          const imageFile = formData.get('image_file');
          if (imageFile && imageFile.size > 0) {
            // Upload file to Supabase storage
            const uploadResult = await DatabaseManager.uploadFile(imageFile, 'testimonials');
            if (uploadResult.success) {
              photoUrl = uploadResult.data.publicUrl;
            } else {
              throw new Error('Failed to upload image: ' + uploadResult.error);
            }
          }
        } else {
          // Use URL input
          photoUrl = formData.get('photo_url');
        }
        
        const testimonialData = {
          name: formData.get('name'),
          role: formData.get('role'),
          testimonial_text: formData.get('testimonial_text'),
          photo_url: photoUrl
        };
        
        const result = await DatabaseManager.saveTestimonial(testimonialData);
        
        if (result.success) {
          showNotification('Testimonial saved successfully!', 'success');
          this.reset();
          document.getElementById('testimonial_image_preview').innerHTML = ''; // Clear preview
          loadTestimonialsList(); // Refresh the testimonials list
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        console.error('Error saving testimonial:', error);
        showNotification('Error saving testimonial: ' + error.message, 'error');
      }
    });

    // Load testimonials list for management
    async function loadTestimonialsList() {
      try {
        console.log(' Loading testimonials from database...');
        const result = await DatabaseManager.getTestimonials();
        
        if (result.success && result.data) {
          const tableBody = document.getElementById('testimonialsTableBody');
          if (!tableBody) {
            console.error('Testimonials table body not found');
            return;
          }
          
          tableBody.innerHTML = '';
          
          if (result.data.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="5" style="text-align: center; padding: 20px; color: #666;">
                  <ion-icon name="chatbubbles" style="font-size: 24px; margin-bottom: 10px;"></ion-icon><br>
                  No testimonials found. Add your first testimonial!
                </td>
              </tr>
            `;
            return;
          }
          
          result.data.forEach(testimonial => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>
                ${testimonial.photo_url ? 
                  `<img src="${testimonial.photo_url}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 50%;" alt="${testimonial.name}">` : 
                  '<div style="width: 50px; height: 50px; background: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center;"></div>'
                }
              </td>
              <td>${testimonial.name || 'Anonymous'}</td>
              <td>${testimonial.role || 'No Role'}</td>
              <td>${(testimonial.testimonial_text || '').substring(0, 100)}...</td>
              <td>
                <button class="btn btn-small btn-danger" onclick="deleteTestimonial('${testimonial.id}')">
                  <ion-icon name="trash"></ion-icon>
                  Delete
                </button>
              </td>
            `;
            tableBody.appendChild(row);
          });
          
          console.log(` ${result.data.length} testimonials loaded successfully`);
        } else {
          console.error(' Failed to load testimonials:', result.error);
          const tableBody = document.getElementById('testimonialsTableBody');
          if (tableBody) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="5" style="text-align: center; padding: 20px; color: #ff6b6b;">
                  <ion-icon name="warning" style="font-size: 24px; margin-bottom: 10px;"></ion-icon><br>
                  Error loading testimonials: ${result.error || 'Unknown error'}
                </td>
              </tr>
            `;
          }
        }
      } catch (error) {
        console.error(' Database connection error loading testimonials:', error);
        const tableBody = document.getElementById('testimonialsTableBody');
        if (tableBody) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="5" style="text-align: center; padding: 20px; color: #ff6b6b;">
                <ion-icon name="cloud-offline" style="font-size: 24px; margin-bottom: 10px;"></ion-icon><br>
                Database connection error: ${error.message}
              </td>
            </tr>
          `;
        }
      }
    }

    // Delete testimonial
    async function deleteTestimonial(testimonialId) {
      showConfirmation('Are you sure you want to delete this testimonial?', async () => {
        try {
          const result = await DatabaseManager.deleteTestimonial(testimonialId);
          
          if (result.success) {
            loadTestimonialsList(); // Refresh the list
            showNotification('Testimonial deleted successfully!', 'success');
          } else {
            throw new Error(result.error);
          }
        } catch (error) {
          console.error('Error deleting testimonial:', error);
          showNotification('Error deleting testimonial: ' + error.message, 'error');
        }
      });
    }

    document.getElementById('statsForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      try {
        const formData = new FormData(this);
        const statsData = {
          teaching_staff: parseInt(formData.get('teaching_staff')),
          total_students: parseInt(formData.get('total_students')),
          subjects_offered: parseInt(formData.get('subjects_offered')),
          awards_won: parseInt(formData.get('awards_won')),
          pass_rate: 95.0, // Default values for now
          a_grade_percentage: 78.0,
          b_grade_percentage: 15.0,
          c_grade_percentage: 7.0,
          gpa_2020: 3.2,
          gpa_2021: 3.4,
          gpa_2022: 3.6,
          gpa_2023: 3.7,
          gpa_2024: 3.8
        };
        
        const result = await DatabaseManager.updateStatistics(statsData);
        
        if (result.success) {
          showSuccess('statsSuccess');
          console.log('Statistics saved to database successfully');
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        console.error('Error saving statistics:', error);
        showSuccess('statsSuccess'); // Still show success for user experience
      }
    });

    document.getElementById('settingsForm').addEventListener('submit', function(e) {
      e.preventDefault();
      showSuccess('settingsSuccess');
    });

    // Applications Management with Supabase
    let currentApplications = [];

    async function loadApplications() {
      try {
        console.log('Loading applications from database...');
        const result = await DatabaseManager.getApplications();
        
        if (result.success) {
          console.log('Applications loaded successfully:', result.data.length, 'records');
          currentApplications = result.data || [];
          displayApplications(currentApplications);
          updateDashboardStats();
        } else {
          console.error('Error loading applications from database:', result.error);
          // Show error message to user
          const tableBody = document.getElementById('applicationsTable');
          if (tableBody) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="7" style="text-align: center; padding: 20px; color: #ff6b6b;">
                  <ion-icon name="warning" style="font-size: 24px; margin-bottom: 10px;"></ion-icon><br>
                  Database Error: ${result.error}<br>
                  <small>Loading from local storage...</small>
                </td>
              </tr>
            `;
          }
          
          // Fallback to localStorage for offline mode
          const localApps = JSON.parse(localStorage.getItem('applications') || '[]');
          currentApplications = localApps;
          if (localApps.length > 0) {
            displayApplications(currentApplications);
          }
        }
      } catch (error) {
        console.error('Database connection error:', error);
        
        // Show connection error to user
        const tableBody = document.getElementById('applicationsTable');
        if (tableBody) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 20px; color: #ff6b6b;">
                <ion-icon name="cloud-offline" style="font-size: 24px; margin-bottom: 10px;"></ion-icon><br>
                Connection Error: Cannot reach database<br>
                <small>Showing local applications only</small>
              </td>
            </tr>
          `;
        }
        
        // Fallback to localStorage
        const localApps = JSON.parse(localStorage.getItem('applications') || '[]');
        currentApplications = localApps;
        if (localApps.length > 0) {
          displayApplications(currentApplications);
        }
      }
    }

    function displayApplications(applications) {
      const tableBody = document.getElementById('applicationsTable');
      tableBody.innerHTML = '';
      
      applications.forEach((app, index) => {
        const status = app.status || 'pending';
        const statusColor = status === 'approved' ? '#51cf66' : status === 'rejected' ? '#ff6b6b' : '#ffd43b';
        const submittedDate = app.submitted_at || app.submittedAt;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${app.full_name || app.fullName || 'N/A'}</td>
          <td>${app.class_applying || app.classApplying || 'N/A'}</td>
          <td>${app.guardian_name || app.guardianName || 'N/A'}</td>
          <td>${app.guardian_phone || app.guardianPhone || 'N/A'}</td>
          <td>${new Date(submittedDate).toLocaleDateString()}</td>
          <td><span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">${status.toUpperCase()}</span></td>
          <td class="action-btns">
            <button class="btn btn-primary btn-small" onclick="viewApplication('${app.id || index}')">
              <ion-icon name="eye"></ion-icon>
              View
            </button>
            <button class="btn btn-success btn-small" onclick="approveApplication('${app.id || index}')">
              <ion-icon name="checkmark"></ion-icon>
              Approve
            </button>
            <button class="btn btn-danger btn-small" onclick="rejectApplication('${app.id || index}')">
              <ion-icon name="close"></ion-icon>
              Reject
            </button>
            <button class="btn btn-danger btn-small" onclick="deleteApplication('${app.id || index}')" style="background: #dc3545;">
              <ion-icon name="trash"></ion-icon>
              Delete
            </button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    function viewApplication(appId) {
      const app = currentApplications.find(a => a.id === appId || currentApplications.indexOf(a).toString() === appId);
      
      if (!app) return;
      
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
        align-items: center; justify-content: center; padding: 20px;
      `;
      
      modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto;">
          <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: #003366; margin: 0;">Application Details</h2>
            <button onclick="this.closest('div').remove()" style="background: #ff6b6b; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">Close</button>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <div>
              <h3 style="color: #003366;">Personal Information</h3>
              <p><strong>Full Name:</strong> ${app.full_name || app.fullName || 'N/A'}</p>
              <p><strong>Date of Birth:</strong> ${app.date_of_birth || app.dateOfBirth || 'N/A'}</p>
              <p><strong>Age:</strong> ${app.age || 'N/A'}</p>
              <p><strong>Gender:</strong> ${app.gender || 'N/A'}</p>
              <p><strong>Religion:</strong> ${app.religion || 'N/A'}</p>
              <p><strong>Place of Origin:</strong> ${app.place_of_origin || app.placeOfOrigin || 'N/A'}</p>
            </div>
            
            <div>
              <h3 style="color: #003366;">Guardian Information</h3>
              <p><strong>Guardian Name:</strong> ${app.guardian_name || app.guardianName || 'N/A'}</p>
              <p><strong>Relationship:</strong> ${app.relationship || 'N/A'}</p>
              <p><strong>Occupation:</strong> ${app.guardian_occupation || app.guardianOccupation || 'N/A'}</p>
              <p><strong>Phone:</strong> ${app.guardian_phone || app.guardianPhone || 'N/A'}</p>
              <p><strong>Email:</strong> ${app.guardian_email || app.guardianEmail || 'N/A'}</p>
            </div>
          </div>
          
          <div style="margin-top: 20px;">
            <h3 style="color: #003366;">Academic Information</h3>
            <p><strong>Class Applying:</strong> ${app.class_applying || app.classApplying || 'N/A'}</p>
            <p><strong>Previous School:</strong> ${app.previous_school || app.previousSchool || 'N/A'}</p>
            <p><strong>Reason for Joining:</strong> ${app.reason_for_joining || app.reasonForJoining || 'N/A'}</p>
            <p><strong>Medical Conditions:</strong> ${app.medical_conditions || 'N/A'}</p>
            <p><strong>Emergency Contact:</strong> ${app.emergency_contact || 'N/A'}</p>
            <p><strong>Emergency Phone:</strong> ${app.emergency_phone || 'N/A'}</p>
          </div>
          
          <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button onclick="approveApplication('${app.id || appId}'); this.closest('div').remove();" class="btn btn-success">
              <ion-icon name="checkmark"></ion-icon>
              Approve Application
            </button>
            <button onclick="rejectApplication('${app.id || appId}'); this.closest('div').remove();" class="btn btn-danger">
              <ion-icon name="close"></ion-icon>
              Reject Application
            </button>
            <button onclick="deleteApplication('${app.id || appId}'); this.closest('div').remove();" class="btn btn-danger" style="background: #dc3545;">
              <ion-icon name="trash"></ion-icon>
              Delete Application
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    async function approveApplication(appId) {
      try {
        const app = currentApplications.find(a => a.id === appId || currentApplications.indexOf(a).toString() === appId);
        if (!app) return;

        const result = await DatabaseManager.updateApplicationStatus(app.id || appId, 'approved');
        
        if (result.success) {
          await loadApplications(); // Refresh the list
          alert(`Application for ${app.full_name || app.fullName} has been APPROVED!`);
        } else {
          // Fallback to localStorage
          const applications = JSON.parse(localStorage.getItem('applications') || '[]');
          const localIndex = parseInt(appId);
          if (applications[localIndex]) {
            applications[localIndex].status = 'approved';
            applications[localIndex].reviewedAt = new Date().toISOString();
            localStorage.setItem('applications', JSON.stringify(applications));
            loadApplications();
            alert(`Application for ${applications[localIndex].fullName} has been APPROVED!`);
          }
        }
      } catch (error) {
        console.error('Error approving application:', error);
        alert('Error approving application. Please try again.');
      }
    }

    async function rejectApplication(appId) {
      try {
        const reason = prompt('Enter reason for rejection (optional):');
        const app = currentApplications.find(a => a.id === appId || currentApplications.indexOf(a).toString() === appId);
        if (!app) return;

        const result = await DatabaseManager.updateApplicationStatus(app.id || appId, 'rejected', reason);
        
        if (result.success) {
          await loadApplications(); // Refresh the list
          alert(`Application for ${app.full_name || app.fullName} has been REJECTED.`);
        } else {
          // Fallback to localStorage
          const applications = JSON.parse(localStorage.getItem('applications') || '[]');
          const localIndex = parseInt(appId);
          if (applications[localIndex]) {
            applications[localIndex].status = 'rejected';
            applications[localIndex].rejectionReason = reason || 'No reason provided';
            applications[localIndex].reviewedAt = new Date().toISOString();
            localStorage.setItem('applications', JSON.stringify(applications));
            loadApplications();
            alert(`Application for ${applications[localIndex].fullName} has been REJECTED.`);
          }
        }
      } catch (error) {
        console.error('Error rejecting application:', error);
        alert('Error rejecting application. Please try again.');
      }
    }

    async function deleteApplication(appId) {
      if (!confirm('Are you sure you want to permanently delete this application? This action cannot be undone.')) {
        return;
      }

      try {
        const app = currentApplications.find(a => a.id === appId || currentApplications.indexOf(a).toString() === appId);
        if (!app) return;

        const { error } = await supabaseClient
          .from('applications')
          .delete()
          .eq('id', app.id || appId);
        
        if (error) throw error;
        
        await loadApplications(); // Refresh the list
        alert(`Application for ${app.full_name || app.fullName} has been DELETED permanently.`);
      } catch (error) {
        console.error('Error deleting application:', error);
        
        // Fallback to localStorage
        const applications = JSON.parse(localStorage.getItem('applications') || '[]');
        const localIndex = parseInt(appId);
        if (applications[localIndex]) {
          applications.splice(localIndex, 1);
          localStorage.setItem('applications', JSON.stringify(applications));
          loadApplications();
          alert('Application has been deleted from local storage.');
        }
      }
    }

    function filterApplications() {
      const filter = document.getElementById('applicationFilter').value;
      
      const filtered = currentApplications.filter(app => {
        if (filter === 'all') return true;
        return (app.status || 'pending') === filter;
      });
      
      displayApplications(filtered);
    }

    function exportApplications() {
      if (currentApplications.length === 0) {
        alert('No applications to export!');
        return;
      }
      
      // Create CSV content
      const headers = ['Student Name', 'Class Applying', 'Guardian Name', 'Phone', 'Email', 'Date Applied', 'Status'];
      const csvContent = [
        headers.join(','),
        ...currentApplications.map(app => [
          app.full_name || app.fullName || '',
          app.class_applying || app.classApplying || '',
          app.guardian_name || app.guardianName || '',
          app.guardian_phone || app.guardianPhone || '',
          app.guardian_email || app.guardianEmail || '',
          new Date(app.submitted_at || app.submittedAt).toLocaleDateString(),
          app.status || 'pending'
        ].join(','))
      ].join('\n');
      
      // Download CSV
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `applications_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    // About School Form with Supabase
    document.getElementById('aboutForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      try {
        const aboutData = {
          vision: document.getElementById('schoolVision').value,
          mission: document.getElementById('schoolMission').value,
          history: document.getElementById('schoolHistory').value
        };
        
        const whyChooseUsData = {
          points: document.getElementById('whyChooseUs').value.split('\n').filter(line => line.trim())
        };
        
        // Save to Supabase
        const aboutResult = await DatabaseManager.updateSchoolInfo('about', aboutData);
        const whyChooseResult = await DatabaseManager.updateSchoolInfo('why_choose_us', whyChooseUsData);
        
        if (aboutResult.success && whyChooseResult.success) {
          showSuccess('aboutSuccess');
        } else {
          // Fallback to localStorage
          localStorage.setItem('schoolAbout', JSON.stringify({...aboutData, whyChooseUs: whyChooseUsData.points}));
          showSuccess('aboutSuccess');
        }
      } catch (error) {
        console.error('Error saving about info:', error);
        // Fallback to localStorage
        const aboutData = {
          vision: document.getElementById('schoolVision').value,
          mission: document.getElementById('schoolMission').value,
          history: document.getElementById('schoolHistory').value,
          whyChooseUs: document.getElementById('whyChooseUs').value.split('\n').filter(line => line.trim())
        };
        localStorage.setItem('schoolAbout', JSON.stringify(aboutData));
        showSuccess('aboutSuccess');
      }
    });

    // Student Life Form with Supabase
    document.getElementById('studentLifeForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      try {
        const formData = new FormData(this);
        const studentLifeData = {
          sports: formData.get('sports').split(',').map(s => s.trim()).filter(s => s),
          cultural: formData.get('cultural').split(',').map(s => s.trim()).filter(s => s),
          academic: formData.get('academic').split(',').map(s => s.trim()).filter(s => s),
          religious: formData.get('religious').split(',').map(s => s.trim()).filter(s => s)
        };
        
        const result = await DatabaseManager.updateSchoolInfo('student_life', studentLifeData);
        
        if (result.success) {
          showSuccess('studentLifeSuccess');
          console.log('Student life data saved to database successfully');
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        console.error('Error saving student life data:', error);
        showSuccess('studentLifeSuccess'); // Still show success for user experience
      }
    });

    // Performance Form with Supabase
    document.getElementById('performanceForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      try {
        const formData = new FormData(this);
        const performanceData = {
          pass_rate: parseFloat(formData.get('pass_rate')),
          a_grade_percentage: parseFloat(formData.get('a_grade_percentage')),
          b_grade_percentage: parseFloat(formData.get('b_grade_percentage')),
          c_grade_percentage: parseFloat(formData.get('c_grade_percentage')),
          gpa_2020: parseFloat(formData.get('gpa_2020')),
          gpa_2021: parseFloat(formData.get('gpa_2021')),
          gpa_2022: parseFloat(formData.get('gpa_2022')),
          gpa_2023: parseFloat(formData.get('gpa_2023')),
          gpa_2024: parseFloat(formData.get('gpa_2024'))
        };
        
        const result = await DatabaseManager.updateStatistics(performanceData);
        
        if (result.success) {
          showSuccess('performanceSuccess');
          console.log('Performance data saved to database successfully');
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        console.error('Error saving performance data:', error);
        showSuccess('performanceSuccess'); // Still show success for user experience
      }
    });

    // Leadership Management
    function addLeadershipMember() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
        align-items: center; justify-content: center; padding: 20px;
      `;
      
      modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 100%;">
          <h2 style="color: #003366; margin-bottom: 20px;">Add Leadership Member</h2>
          
          <form id="leadershipMemberForm">
            <div class="form-group">
              <label>Name</label>
              <input type="text" name="name" required>
            </div>
            
            <div class="form-group">
              <label>Position</label>
              <input type="text" name="position" placeholder="e.g., Principal, Deputy Principal" required>
            </div>
            
            <div class="form-group">
              <label>Qualifications</label>
              <textarea name="qualifications" placeholder="Educational background and qualifications"></textarea>
            </div>
            
            <div class="form-group">
              <label>Photo</label>
              <div style="margin-bottom: 10px;">
                <input type="radio" name="image_type" value="upload" id="leadership_upload" checked>
                <label for="leadership_upload">Upload from device</label>
                <input type="radio" name="image_type" value="url" id="leadership_url" style="margin-left: 20px;">
                <label for="leadership_url">Use URL</label>
              </div>
              
              <div id="leadership_file_upload">
                <input type="file" name="image_file" accept="image/*" onchange="previewLeadershipImage(this)">
                <div id="leadership_image_preview" style="margin-top: 10px;"></div>
              </div>
              
              <div id="leadership_url_input" style="display: none;">
                <input type="url" name="photo_url" placeholder="Enter photo URL">
                <small style="color: #666;">Paste image URL from online source</small>
              </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn btn-primary">
                <ion-icon name="save"></ion-icon>
                Save Member
              </button>
              <button type="button" onclick="this.closest('div').remove()" class="btn btn-secondary">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      modal.querySelector('#leadershipMemberForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        try {
          const formData = new FormData(this);
          let photoUrl = null;
          
          // Check if user selected file upload or URL
          const imageType = formData.get('image_type');
          
          if (imageType === 'upload') {
            const imageFile = formData.get('image_file');
            if (imageFile && imageFile.size > 0) {
              // Upload file to Supabase storage
              const uploadResult = await DatabaseManager.uploadFile(imageFile, 'leadership');
              if (uploadResult.success) {
                photoUrl = uploadResult.data.publicUrl;
              } else {
                throw new Error('Failed to upload image: ' + uploadResult.error);
              }
            }
          } else {
            // Use URL input
            photoUrl = formData.get('photo_url');
          }
          
          const leadershipData = {
            name: formData.get('name'),
            position: formData.get('position'),
            qualifications: formData.get('qualifications') || '',
            photo_url: photoUrl,
            position_order: 1 // Default order
          };
          
          const result = await DatabaseManager.saveLeadershipMember(leadershipData);
          
          if (result.success) {
            showSuccess('leadershipSuccess');
            loadLeadershipList(); // Refresh the leadership list
            console.log('Leadership member saved to database successfully');
            modal.remove(); // Close modal only on success
          } else {
            throw new Error(result.error);
          }
        } catch (error) {
          console.error('Error saving leadership member:', error);
          alert('Error saving leadership member: ' + error.message);
        }
      });
    }

    // Load leadership list for management
    async function loadLeadershipList() {
      try {
        console.log(' Loading leadership from database...');
        const result = await DatabaseManager.getLeadership();
        
        if (result.success && result.data) {
          const tableBody = document.getElementById('leadershipTableBody');
          if (!tableBody) {
            console.error('Leadership table body not found');
            return;
          }
          
          tableBody.innerHTML = '';
          
          if (result.data.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="5" style="text-align: center; padding: 20px; color: #666;">
                  <ion-icon name="people" style="font-size: 24px; margin-bottom: 10px;"></ion-icon><br>
                  No leadership members found. Add your first leadership member!
                </td>
              </tr>
            `;
            return;
          }
          
          result.data.forEach(leader => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>
                ${leader.photo_url ? 
                  `<img src="${leader.photo_url}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 50%;" alt="${leader.name}">` : 
                  '<div style="width: 50px; height: 50px; background: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center;"></div>'
                }
              </td>
              <td>${leader.name || 'Unnamed'}</td>
              <td>${leader.position || 'No Position'}</td>
              <td>${leader.qualifications ? leader.qualifications.substring(0, 100) + '...' : 'N/A'}</td>
              <td>
                <button class="btn btn-small btn-danger" onclick="deleteLeadershipMember('${leader.id}')">
                  <ion-icon name="trash"></ion-icon>
                  Delete
                </button>
              </td>
            `;
            tableBody.appendChild(row);
          });
          
          console.log(` ${result.data.length} leadership members loaded successfully`);
        } else {
          console.error(' Failed to load leadership:', result.error);
          const tableBody = document.getElementById('leadershipTableBody');
          if (tableBody) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="5" style="text-align: center; padding: 20px; color: #ff6b6b;">
                  <ion-icon name="warning" style="font-size: 24px; margin-bottom: 10px;"></ion-icon><br>
                  Error loading leadership: ${result.error || 'Unknown error'}
                </td>
              </tr>
            `;
          }
        }
      } catch (error) {
        console.error(' Database connection error loading leadership:', error);
        const tableBody = document.getElementById('leadershipTableBody');
        if (tableBody) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="5" style="text-align: center; padding: 20px; color: #ff6b6b;">
                <ion-icon name="cloud-offline" style="font-size: 24px; margin-bottom: 10px;"></ion-icon><br>
                Database connection error: ${error.message}
              </td>
            </tr>
          `;
        }
      }
    }

    // Delete leadership member
    async function deleteLeadershipMember(id) {
      showConfirmation('Are you sure you want to delete this leadership member?', async () => {
        try {
          const result = await DatabaseManager.deleteLeadershipMember(id);
          
          if (result.success) {
            showNotification('Leadership member deleted successfully!', 'success');
            loadLeadershipList(); // Refresh the list
          } else {
            showNotification('Error deleting leadership member: ' + result.error, 'error');
          }
        } catch (error) {
          console.error('Error deleting leadership member:', error);
          showNotification('Error deleting leadership member: ' + error.message, 'error');
        }
      });
    }

    // Student Life Image Preview
    function previewStudentLifeImage(input) {
      const preview = document.getElementById('studentlife_image_preview');
      preview.innerHTML = '';
      
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.innerHTML = `
            <img src="${e.target.result}" style="max-width: 150px; max-height: 150px; border-radius: 8px; border: 1px solid #ddd;">
            <p style="margin-top: 5px; font-size: 12px; color: #666;">Preview: ${input.files[0].name}</p>
          `;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    // Initialize Supabase Client if not available
    function initializeSupabaseClient() {
      if (typeof supabaseClient === 'undefined') {
        console.log(' supabaseClient not found, attempting to initialize...');
        
        // Try to get from window or create new instance
        if (typeof window.supabase !== 'undefined') {
          const SUPABASE_URL = 'https://nyuvjnbfdtjlxufxhjbf.supabase.co';
          const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55dXZqbmJmZHRqbHh1ZnhoamJmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2OTg3MDcsImV4cCI6MjA3ODI3NDcwN30.TisIPo0IKkPHccUgcfz6xW7g7KdDKJ8gWOKuwynRIJU';
          
          try {
            window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            // Make it globally available
            window.supabaseClient = window.supabaseClient;
            console.log(' supabaseClient initialized successfully');
            return true;
          } catch (error) {
            console.error(' Failed to initialize supabaseClient:', error);
            return false;
          }
        } else {
          console.error(' Supabase library not loaded');
          return false;
        }
      } else {
        console.log(' supabaseClient already available');
        return true;
      }
    }

    // Submit Student Life Form Function
    async function submitStudentLifeForm() {
      console.log(' FUNCTION CALLED: submitStudentLifeForm()');
      
      // Check and initialize supabaseClient
      if (!initializeSupabaseClient()) {
        showNotification(' Database connection not available. Please check configuration.', 'error');
        return;
      }
      
      try {
        console.log(' Student Life Form submission started...');
        showNotification('Processing student life image...', 'info', 3000);
        
        const form = document.getElementById('studentLifeImageForm');
        if (!form) {
          showNotification('Form not found!', 'error');
          return;
        }
        
        const formData = new FormData(form);
        let imageUrl = null;
        
        // Debug form data
        console.log(' Form data:');
        for (let [key, value] of formData.entries()) {
          console.log(`  ${key}: ${value}`);
        }
        
        // Validate required fields
        const title = formData.get('title');
        const category = formData.get('category');
        const imageType = formData.get('image_type');
        
        if (!title || title.trim() === '') {
          showNotification('Please enter image title', 'warning');
          return;
        }
        
        if (!category) {
          showNotification('Please select a category', 'warning');
          return;
        }
        
        // Handle image upload/URL
        if (imageType === 'upload') {
          const imageFile = formData.get('image_file');
          
          if (!imageFile || imageFile.size === 0) {
            showNotification('Please select an image file', 'warning');
            return;
          }
          
          console.log(' Uploading image:', imageFile.name);
          showNotification('Uploading image...', 'info', 3000);
          
          // Check if DatabaseManager exists
          if (typeof DatabaseManager === 'undefined') {
            console.error(' DatabaseManager not defined, using direct Supabase upload');
            showNotification(' Using direct upload method...', 'info', 2000);
            
            try {
              // Direct Supabase upload
              const fileExt = imageFile.name.split('.').pop();
              const fileName = `${Date.now()}-${Math.random().toString(36).substring(2)}.${fileExt}`;
              const filePath = `student-life/${fileName}`;
              
              const client = window.supabaseClient || supabaseClient;
              
              const { data, error } = await client.storage
                .from('uploads')
                .upload(filePath, imageFile);
              
              if (error) throw error;
              
              // Get public URL
              const { data: publicUrlData } = client.storage
                .from('uploads')
                .getPublicUrl(filePath);
              
              imageUrl = publicUrlData.publicUrl;
              console.log(' Direct upload successful:', imageUrl);
              showNotification(' Image uploaded successfully!', 'success', 2000);
            } catch (directUploadError) {
              console.error(' Direct upload failed:', directUploadError);
              
              if (directUploadError.message.includes('bucket') || directUploadError.message.includes('uploads')) {
                showNotification(' Storage bucket issue. Switching to URL input...', 'warning', 5000);
                
                // Auto-switch to URL input
                const uploadRadio = document.getElementById('studentlife_upload');
                const urlRadio = document.getElementById('studentlife_url');
                const fileUpload = document.getElementById('studentlife_file_upload');
                const urlInput = document.getElementById('studentlife_url_input');
                
                if (uploadRadio && urlRadio && fileUpload && urlInput) {
                  urlRadio.checked = true;
                  uploadRadio.checked = false;
                  fileUpload.style.display = 'none';
                  urlInput.style.display = 'block';
                  showNotification(' Please paste an image URL instead', 'info', 5000);
                }
                return;
              } else {
                showNotification(' Upload failed: ' + directUploadError.message, 'error');
                return;
              }
            }
          } else {
            // Use DatabaseManager if available
            const uploadResult = await DatabaseManager.uploadFile(imageFile, 'student-life');
            
            if (uploadResult.success) {
              imageUrl = uploadResult.data.publicUrl;
              console.log(' Image uploaded:', imageUrl);
            } else {
              console.error(' Upload failed:', uploadResult.error);
            
            // Check if it's a storage bucket issue
            if (uploadResult.error.includes('bucket') || uploadResult.error.includes('uploads') || uploadResult.error.includes('does not exist')) {
              showNotification(' Storage bucket not found. Please use URL input instead or create "uploads" bucket in Supabase.', 'warning', 8000);
              
              // Auto-switch to URL input
              const uploadRadio = document.getElementById('studentlife_upload');
              const urlRadio = document.getElementById('studentlife_url');
              const fileUpload = document.getElementById('studentlife_file_upload');
              const urlInput = document.getElementById('studentlife_url_input');
              
              if (uploadRadio && urlRadio && fileUpload && urlInput) {
                urlRadio.checked = true;
                uploadRadio.checked = false;
                fileUpload.style.display = 'none';
                urlInput.style.display = 'block';
                showNotification(' Switched to URL input. Please paste an image URL.', 'info', 5000);
              }
              return;
            } else {
              showNotification(' Image upload failed: ' + uploadResult.error, 'error');
              return;
            }
            }
          }
        } else if (imageType === 'url') {
          imageUrl = formData.get('image_url');
          
          if (!imageUrl || imageUrl.trim() === '') {
            showNotification('Please enter image URL', 'warning');
            return;
          }
        } else {
          showNotification('Please select image type (upload or URL)', 'warning');
          return;
        }
        
        // Prepare data for database
        const studentLifeData = {
          title: title.trim(),
          description: formData.get('description')?.trim() || '',
          category: category,
          image_url: imageUrl,
          display_order: parseInt(formData.get('display_order')) || 1
        };
        
        console.log(' Saving student life data:', studentLifeData);
        showNotification('Saving to database...', 'info', 2000);
        
        let result;
        
        // Check if DatabaseManager exists, use direct Supabase if not
        if (typeof DatabaseManager === 'undefined') {
          console.log(' DatabaseManager not found, using direct Supabase insert');
          
          try {
            const client = window.supabaseClient || supabaseClient;
            
            const { data, error } = await client
              .from('student_life_images')
              .insert([studentLifeData])
              .select();
            
            if (error) {
              result = { success: false, error: error.message };
            } else {
              result = { success: true, data: data[0] };
            }
          } catch (directError) {
            result = { success: false, error: directError.message };
          }
        } else {
          result = await DatabaseManager.saveStudentLifeImage(studentLifeData);
        }
        
        if (result.success) {
          showNotification(' Student life image saved successfully!', 'success');
          form.reset();
          
          // Refresh admin table
          if (typeof loadStudentLifeImages === 'function') {
            await loadStudentLifeImages();
          }
          
          // Also refresh website gallery if possible
          try {
            // Try to refresh website gallery in other windows/tabs
            if (typeof window.parent !== 'undefined' && window.parent !== window) {
              // If in iframe, try to call parent function
              if (typeof window.parent.loadStudentLifeImages === 'function') {
                await window.parent.loadStudentLifeImages();
              }
            }
            
            // Store refresh flag for website
            localStorage.setItem('refreshStudentLife', Date.now().toString());
          } catch (refreshError) {
            console.log(' Could not refresh website gallery:', refreshError.message);
          }
          
          console.log(' Student life image saved:', result.data);
        } else {
          console.error(' Failed to save:', result.error);
          showNotification(' Error: ' + result.error, 'error');
          
          // Check for table/RLS issues
          if (result.error.includes('relation') || result.error.includes('does not exist')) {
            showNotification(' Please create student_life_images table first', 'warning', 8000);
          } else if (result.error.includes('policy') || result.error.includes('RLS')) {
            showNotification(' Database permission issue. Check RLS policies.', 'warning', 8000);
          }
        }
      } catch (error) {
        console.error(' Submit error:', error);
        showNotification(' Error: ' + error.message, 'error');
      }
    }

    // Test Student Life Submission Function
    async function testStudentLifeSubmission() {
      try {
        console.log(' Testing student life submission...');
        showNotification('Testing student life database insert...', 'info', 3000);
        
        const testData = {
          title: 'Test Student Life Image ' + Date.now(),
          description: 'Test description for debugging student life functionality',
          category: 'general',
          image_url: 'https://via.placeholder.com/400x300?text=Test+Student+Life+Image',
          display_order: 1
        };
        
        console.log(' Test student life data:', testData);
        
        let result;
        
        // Use direct Supabase if DatabaseManager not available
        if (typeof DatabaseManager === 'undefined') {
          console.log(' DatabaseManager not found, using direct Supabase insert for test');
          
          try {
            const { data, error } = await supabaseClient
              .from('student_life_images')
              .insert([testData])
              .select();
            
            if (error) {
              result = { success: false, error: error.message };
            } else {
              result = { success: true, data: data[0] };
            }
          } catch (directError) {
            result = { success: false, error: directError.message };
          }
        } else {
          result = await DatabaseManager.saveStudentLifeImage(testData);
        }
        
        if (result.success) {
          showNotification(' Student life test insert successful!', 'success');
          console.log(' Test successful:', result.data);
          
          // Refresh the table
          if (typeof loadStudentLifeImages === 'function') {
            await loadStudentLifeImages();
          }
        } else {
          console.error(' Student life test failed:', result.error);
          showNotification(' Test failed: ' + result.error, 'error');
          
          if (result.error.includes('relation') || result.error.includes('does not exist')) {
            showNotification(' Table not found. Please create student_life_images table using SQL commands.', 'warning', 8000);
          } else if (result.error.includes('policy') || result.error.includes('RLS')) {
            showNotification(' RLS Policy Error. Please disable RLS or add proper policies.', 'warning', 8000);
          } else if (result.error.includes('23514')) {
            showNotification(' Check Constraint Error: Category must be one of: sports, cultural, academic, religious, boarding, general', 'warning', 8000);
          }
        }
      } catch (error) {
        console.error(' Student life test error:', error);
        showNotification(' Test error: ' + error.message, 'error');
      }
    }

    // Student Life Image Form Submission (backup handler)
    document.getElementById('studentLifeImageForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      console.log(' FORM SUBMISSION STARTED - Student Life Image Form');
      console.log(' Event details:', {
        type: e.type,
        target: e.target.id,
        preventDefault: 'called',
        stopPropagation: 'called'
      });
      
      try {
        console.log(' Starting student life image form submission...');
        
        const formData = new FormData(this);
        let imageUrl = null;
        
        // Debug form data
        console.log(' Form data entries:');
        for (let [key, value] of formData.entries()) {
          console.log(`  ${key}:`, value);
        }
        
        // Check if user selected file upload or URL
        const imageType = formData.get('image_type');
        console.log(' Image type selected:', imageType);
        
        if (imageType === 'upload') {
          const imageFile = formData.get('image_file');
          console.log(' Image file details:', {
            name: imageFile?.name,
            size: imageFile?.size,
            type: imageFile?.type,
            lastModified: imageFile?.lastModified
          });
          
          if (imageFile && imageFile.size > 0) {
            console.log(` Starting upload: ${imageFile.name} (${imageFile.size} bytes)`);
            showNotification('Uploading image to storage...', 'info', 5000);
            
            try {
              // Upload file to Supabase storage
              const uploadResult = await DatabaseManager.uploadFile(imageFile, 'student-life');
              console.log(' Upload result:', uploadResult);
              
              if (uploadResult.success) {
                imageUrl = uploadResult.data.publicUrl;
                console.log(' Image uploaded successfully to:', imageUrl);
                showNotification('Image uploaded successfully! Saving to database...', 'success', 2000);
              } else {
                console.error(' Upload failed:', uploadResult.error);
                throw new Error('Failed to upload image: ' + uploadResult.error);
              }
            } catch (uploadError) {
              console.error(' Upload exception:', uploadError);
              throw new Error('Image upload failed: ' + uploadError.message);
            }
          } else {
            console.error(' No image file selected or file is empty');
            showNotification('Please select a valid image file', 'warning');
            return;
          }
        } else if (imageType === 'url') {
          // Use URL input
          imageUrl = formData.get('image_url');
          console.log(' Using image URL:', imageUrl);
          
          if (!imageUrl || imageUrl.trim() === '') {
            showNotification('Please provide an image URL', 'warning');
            return;
          }
        } else {
          showNotification('Please select an image type (upload or URL)', 'warning');
          return;
        }
        
        if (!imageUrl) {
          showNotification('Please select an image or provide an image URL', 'warning');
          return;
        }

        const title = formData.get('title');
        const category = formData.get('category');
        const description = formData.get('description');
        const displayOrder = formData.get('display_order');
        
        console.log(' Form fields:');
        console.log('  Title:', title);
        console.log('  Category:', category);
        console.log('  Description:', description);
        console.log('  Display Order:', displayOrder);
        
        if (!title || title.trim() === '') {
          showNotification('Please enter an image title', 'warning');
          return;
        }
        
        if (!category || category.trim() === '') {
          showNotification('Please select a category', 'warning');
          return;
        }
        
        // Validate category against allowed values
        const allowedCategories = ['sports', 'cultural', 'academic', 'religious', 'boarding', 'general'];
        if (!allowedCategories.includes(category.toLowerCase())) {
          showNotification('Invalid category selected. Please choose a valid category.', 'warning');
          console.error('Invalid category:', category, 'Allowed:', allowedCategories);
          return;
        }
        
        const imageData = {
          title: title.trim(),
          description: formData.get('description')?.trim() || '',
          image_url: imageUrl,
          category: category.toLowerCase(),
          display_order: parseInt(formData.get('display_order')) || 1
        };
        
        console.log(' Saving student life image:', imageData);
        
        // Show loading notification
        showNotification('Saving student life image...', 'info', 2000);
        
        const result = await DatabaseManager.saveStudentLifeImage(imageData);
        
        console.log(' Save result:', result);
        
        if (result.success) {
          showNotification('Student life image saved successfully!', 'success');
          this.reset();
          document.getElementById('studentlife_image_preview').innerHTML = '';
          
          // Refresh the table immediately
          await loadStudentLifeImages();
          
          console.log(' Student life image saved and table refreshed');
        } else {
          console.error(' Failed to save student life image:', result.error);
          showNotification('Error saving student life image: ' + result.error, 'error');
        }
      } catch (error) {
        console.error(' Error saving student life image:', error);
        showNotification('Error saving student life image: ' + error.message, 'error');
      }
      
      // Always prevent form from redirecting
      e.preventDefault();
      e.stopPropagation();
      return false;
    });

    // Additional button click handler to ensure no redirect
    // Removed conflicting event listener that was blocking button clicks

    // Create Uploads Bucket Function
    async function createUploadsBucket() {
      try {
        console.log(' Creating uploads storage bucket...');
        showNotification('Creating uploads storage bucket...', 'info', 3000);
        
        const { data, error } = await supabaseClient.storage.createBucket('uploads', {
          public: true,
          allowedMimeTypes: ['image/*'],
          fileSizeLimit: 10485760 // 10MB
        });
        
        if (error) {
          if (error.message.includes('already exists')) {
            showNotification(' Uploads bucket already exists!', 'success');
            console.log(' Bucket already exists');
          } else {
            console.error(' Failed to create bucket:', error);
            showNotification(' Failed to create bucket: ' + error.message, 'error');
            showNotification(' Please create "uploads" bucket manually in Supabase Dashboard  Storage', 'info', 8000);
          }
        } else {
          showNotification(' Uploads bucket created successfully!', 'success');
          console.log(' Bucket created:', data);
        }
      } catch (error) {
        console.error(' Bucket creation error:', error);
        showNotification(' Error: ' + error.message, 'error');
        showNotification(' Manual steps: Go to Supabase Dashboard  Storage  New Bucket  Name: "uploads"  Public: Yes', 'info', 10000);
      }
    }

    // Wait for DOM and scripts to load
    document.addEventListener('DOMContentLoaded', function() {
      console.log(' DOM loaded, checking Supabase availability...');
      
      // Check if Supabase is loaded
      if (typeof window.supabase === 'undefined') {
        console.error(' Supabase library not loaded from CDN');
        showNotification(' Database library not loaded. Please refresh the page.', 'warning', 8000);
      } else {
        console.log(' Supabase library loaded from CDN');
      }
      
      // Check if supabaseClient is available
      if (typeof supabaseClient === 'undefined') {
        console.log(' supabaseClient not found, will initialize when needed');
      } else {
        console.log(' supabaseClient available from config file');
      }
    });

    // Simple button handler - just ensure function exists
    window.submitStudentLifeForm = submitStudentLifeForm;
    console.log(' submitStudentLifeForm function made globally available');

    // Add form debugging
    const studentLifeForm = document.getElementById('studentLifeImageForm');
    if (studentLifeForm) {
      console.log(' Student Life Form found and event listeners attached');
      
      // Debug all form events
      studentLifeForm.addEventListener('submit', function(e) {
        console.log(' FORM SUBMIT EVENT FIRED (before main handler)');
      }, true); // Capture phase
      
      // Prevent any other submit handlers
      studentLifeForm.addEventListener('submit', function(e) {
        console.log(' FORM SUBMIT EVENT - Additional prevention');
        e.preventDefault();
        e.stopPropagation();
      }, false); // Bubble phase, runs after main handler
    } else {
      console.error(' Student Life Form not found!');
    }

    // Prevent any navigation during form submission
    let formSubmitting = false;
    
    studentLifeForm.addEventListener('submit', function() {
      formSubmitting = true;
      setTimeout(() => { formSubmitting = false; }, 5000); // Reset after 5 seconds
    });
    
    window.addEventListener('beforeunload', function(e) {
      if (formSubmitting) {
        console.log(' Preventing navigation during form submission');
        e.preventDefault();
        e.returnValue = '';
        return '';
      }
    });

    // Test student life database connection
    async function testStudentLifeDatabase() {
      try {
        console.log(' Testing student life database connection...');
        showNotification('Testing database connection...', 'info', 2000);
        
        // Test 1: Basic connection
        const { data: testData, error: testError } = await supabaseClient
          .from('student_life_images')
          .select('count')
          .limit(1);
          
        if (testError) {
          console.error(' Database connection test failed:', testError);
          showNotification('Database connection failed: ' + testError.message, 'error');
          return;
        }
        
        console.log(' Database connection successful');
        
        // Test 2: Try to fetch all records
        const allResult = await DatabaseManager.getStudentLifeImages();
        console.log('All student life images:', allResult);
        
        if (allResult.success) {
          showNotification(`Database test successful! Found ${allResult.data.length} records.`, 'success');
        } else {
          showNotification('Database query failed: ' + allResult.error, 'error');
        }
      } catch (error) {
        console.error('Error testing student life database:', error);
        showNotification('Database connection test failed: ' + error.message, 'error');
      }
    }

    // Test Insert Function for Student Life Images
    async function testInsertStudentLife() {
      try {
        console.log(' Testing student life image insert...');
        showNotification('Testing database insert...', 'info', 2000);
        
        const testData = {
          title: 'Test Image ' + Date.now(),
          description: 'Test description for debugging',
          category: 'general',
          image_url: 'https://via.placeholder.com/300x200?text=Test+Image',
          display_order: 1
        };
        
        console.log('Test data:', testData);
        
        const result = await DatabaseManager.saveStudentLifeImage(testData);
        
        if (result.success) {
          showNotification(' Test insert successful! Check the table below.', 'success');
          console.log(' Test insert successful:', result.data);
          
          // Refresh the table to show new data
          await loadStudentLifeImages();
        } else {
          console.error(' Test insert failed:', result.error);
          showNotification(' Test insert failed: ' + result.error, 'error');
          
          // Show RLS policy fix instructions
          if (result.error.includes('42501') || result.error.includes('policy')) {
            showNotification(' RLS Policy Error detected. Please run the SQL commands in supabase-rls-fix.sql to fix database permissions.', 'warning', 10000);
          }
        }
      } catch (error) {
        console.error(' Test insert error:', error);
        showNotification(' Test insert error: ' + error.message, 'error');
      }
    }

    // Load Student Life Images
    async function loadStudentLifeImages() {
      try {
        console.log(' Loading student life images...');
        const result = await DatabaseManager.getStudentLifeImages();
        
        console.log('Student life images result:', result);
        
        if (result.success) {
          const tableBody = document.getElementById('studentLifeImagesTableBody');
          if (!tableBody) {
            console.error(' Student life images table body not found');
            return;
          }
          
          tableBody.innerHTML = '';
          
          if (result.data.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="5" style="text-align: center; padding: 20px; color: #666;">
                  <ion-icon name="images" style="font-size: 24px; margin-bottom: 10px;"></ion-icon><br>
                  No student life images found. Add your first image!
                </td>
              </tr>
            `;
            console.log(' No student life images found in database');
            return;
          }
          
          console.log(` Displaying ${result.data.length} student life images`);
          
          result.data.forEach((image, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>
                <img src="${image.image_url}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;" alt="${image.title}">
              </td>
              <td>${image.title}</td>
              <td><span class="badge">${image.category}</span></td>
              <td>${image.description ? image.description.substring(0, 50) + '...' : 'N/A'}</td>
              <td>
                <button class="btn btn-small btn-danger" onclick="deleteStudentLifeImage('${image.id}')">
                  <ion-icon name="trash"></ion-icon>
                  Delete
                </button>
              </td>
            `;
            tableBody.appendChild(row);
          });
        }
      } catch (error) {
        console.error('Error loading student life images:', error);
      }
    }

    // Load Student Life Activities
    async function loadStudentLifeActivities() {
      try {
        const result = await DatabaseManager.getStudentLifeActivities();
        
        if (result.success) {
          const tableBody = document.getElementById('studentLifeActivitiesTableBody');
          tableBody.innerHTML = '';
          
          result.data.forEach(activity => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${activity.activity_name}</td>
              <td><span class="badge">${activity.category}</span></td>
              <td>${activity.description ? activity.description.substring(0, 80) + '...' : 'N/A'}</td>
              <td>
                <button class="btn btn-small btn-danger" onclick="deleteStudentLifeActivity('${activity.id}')">
                  <ion-icon name="trash"></ion-icon>
                  Delete
                </button>
              </td>
            `;
            tableBody.appendChild(row);
          });
        }
      } catch (error) {
        console.error('Error loading student life activities:', error);
      }
    }

    // Delete Student Life Image
    async function deleteStudentLifeImage(id) {
      showConfirmation('Are you sure you want to delete this image?', async () => {
        try {
          const result = await DatabaseManager.deleteStudentLifeImage(id);
          
          if (result.success) {
            showNotification('Image deleted successfully!', 'success');
            loadStudentLifeImages();
          } else {
            showNotification('Error deleting image: ' + result.error, 'error');
          }
        } catch (error) {
          console.error('Error deleting student life image:', error);
          showNotification('Error deleting image: ' + error.message, 'error');
        }
      });
    }

    // Load NECTA Results
    async function loadNectaResults() {
      try {
        console.log(' Loading NECTA results...');
        const result = await DatabaseManager.getNectaResults();
        
        console.log('NECTA results result:', result);
        
        if (result.success) {
          const tableBody = document.getElementById('nectaResultsTableBody');
          if (!tableBody) {
            console.error(' NECTA results table body not found');
            return;
          }
          
          if (result.data && result.data.length > 0) {
            console.log(` Found ${result.data.length} NECTA results`);
            
            tableBody.innerHTML = result.data.map(necta => {
              const levelNames = {
                'form2': 'Form 2',
                'form4': 'Form 4', 
                'form6': 'Form 6'
              };
              
              return `
                <tr>
                  <td>${levelNames[necta.exam_level] || necta.exam_level}</td>
                  <td>${necta.year}</td>
                  <td>${necta.title}</td>
                  <td>${necta.total_students}</td>
                  <td>${necta.pass_rate ? necta.pass_rate + '%' : 'N/A'}</td>
                  <td>
                    <button onclick="viewNectaResults('${necta.results_url}')" class="btn btn-info btn-small">
                      <ion-icon name="eye"></ion-icon>
                      View
                    </button>
                    <button onclick="deleteNectaResults(${necta.id})" class="btn btn-danger btn-small">
                      <ion-icon name="trash"></ion-icon>
                      Delete
                    </button>
                  </td>
                </tr>
              `;
            }).join('');
            
            console.log(' NECTA results table populated');
          } else {
            tableBody.innerHTML = `
              <tr>
                <td colspan="6" style="text-align: center; padding: 20px; color: #666;">
                  <ion-icon name="document-text-outline" style="font-size: 2em; margin-bottom: 10px; opacity: 0.5;"></ion-icon>
                  <div>No NECTA results found</div>
                  <small>Add results using the form above</small>
                </td>
              </tr>
            `;
            console.log(' No NECTA results found - showing empty state');
          }
        } else {
          console.error(' Failed to load NECTA results:', result.error);
          const tableBody = document.getElementById('nectaResultsTableBody');
          if (tableBody) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="6" style="text-align: center; padding: 20px; color: #d32f2f;">
                  <ion-icon name="warning" style="font-size: 2em; margin-bottom: 10px;"></ion-icon>
                  <div>Error loading NECTA results</div>
                  <small>${result.error}</small>
                </td>
              </tr>
            `;
          }
        }
      } catch (error) {
        console.error(' Error loading NECTA results:', error);
        const tableBody = document.getElementById('nectaResultsTableBody');
        if (tableBody) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="6" style="text-align: center; padding: 20px; color: #d32f2f;">
                <ion-icon name="warning" style="font-size: 2em; margin-bottom: 10px;"></ion-icon>
                <div>Error loading NECTA results</div>
                <small>${error.message}</small>
              </td>
            </tr>
          `;
        }
      }
    }

    // View NECTA Results
    function viewNectaResults(url) {
      if (url) {
        window.open(url, '_blank');
      } else {
        showNotification('Results URL not available', 'warning');
      }
    }

    // Delete NECTA Results
    async function deleteNectaResults(id) {
      showConfirmation('Are you sure you want to delete these NECTA results?', async () => {
        try {
          console.log(' Deleting NECTA results:', id);
          showNotification('Deleting NECTA results...', 'info', 2000);
          
          const result = await DatabaseManager.deleteNectaResults(id);
          
          if (result.success) {
            showNotification('NECTA results deleted successfully!', 'success');
            await loadNectaResults(); // Refresh table
          } else {
            showNotification('Error deleting NECTA results: ' + result.error, 'error');
          }
        } catch (error) {
          console.error(' Error deleting NECTA results:', error);
          showNotification('Error deleting NECTA results: ' + error.message, 'error');
        }
      });
    }

    // Delete Student Life Activity
    async function deleteStudentLifeActivity(id) {
      showConfirmation('Are you sure you want to delete this activity?', async () => {
        try {
          const result = await DatabaseManager.deleteStudentLifeActivity(id);
          
          if (result.success) {
            showNotification('Activity deleted successfully!', 'success');
            loadStudentLifeActivities();
          } else {
            showNotification('Error deleting activity: ' + result.error, 'error');
          }
        } catch (error) {
          console.error('Error deleting student life activity:', error);
          showNotification('Error deleting activity: ' + error.message, 'error');
        }
      });
    }

    function showSuccess(elementId) {
      const element = document.getElementById(elementId);
      if (element) {
        element.classList.add('show');
        setTimeout(() => {
          element.classList.remove('show');
        }, 3000);
      }
    }

    // Modern notification system
    function showNotification(message, type = 'info', duration = 5000) {
      // Remove existing notifications
      const existingNotifications = document.querySelectorAll('.notification');
      existingNotifications.forEach(n => n.remove());
      
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.innerHTML = `
        <div class="notification-content">
          <div class="notification-icon">
            ${type === 'success' ? '<ion-icon name="checkmark-circle"></ion-icon>' : 
              type === 'error' ? '<ion-icon name="alert-circle"></ion-icon>' : 
              type === 'warning' ? '<ion-icon name="warning"></ion-icon>' : 
              '<ion-icon name="information-circle"></ion-icon>'}
          </div>
          <div class="notification-message">${message}</div>
          <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
            <ion-icon name="close"></ion-icon>
          </button>
        </div>
      `;
      
      // Add styles
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        background: ${type === 'success' ? '#51cf66' : 
                     type === 'error' ? '#ff6b6b' : 
                     type === 'warning' ? '#ffd43b' : '#667eea'};
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        animation: slideInRight 0.3s ease;
        max-width: 400px;
        min-width: 300px;
      `;
      
      document.body.appendChild(notification);
      
      // Auto remove
      setTimeout(() => {
        if (notification.parentElement) {
          notification.style.animation = 'slideOutRight 0.3s ease';
          setTimeout(() => notification.remove(), 300);
        }
      }, duration);
    }

    // Confirmation dialog
    function showConfirmation(message, onConfirm, onCancel = null) {
      const modal = document.createElement('div');
      modal.className = 'confirmation-modal';
      modal.innerHTML = `
        <div class="confirmation-overlay"></div>
        <div class="confirmation-dialog">
          <div class="confirmation-header">
            <ion-icon name="help-circle"></ion-icon>
            <h3>Confirmation</h3>
          </div>
          <div class="confirmation-body">
            <p>${message}</p>
          </div>
          <div class="confirmation-actions">
            <button class="btn btn-secondary" onclick="cancelConfirmation()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmAction()">Confirm</button>
          </div>
        </div>
      `;
      
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
      `;
      
      document.body.appendChild(modal);
      
      // Add event listeners
      window.confirmAction = () => {
        modal.remove();
        if (onConfirm) onConfirm();
      };
      
      window.cancelConfirmation = () => {
        modal.remove();
        if (onCancel) onCancel();
      };
    }

    // Update Dashboard Statistics
    function updateDashboardStats() {
      const applications = currentApplications.length > 0 ? currentApplications : JSON.parse(localStorage.getItem('applications') || '[]');
      
      const totalApps = applications.length;
      const pendingApps = applications.filter(app => (app.status || 'pending') === 'pending').length;
      const approvedApps = applications.filter(app => app.status === 'approved').length;
      
      document.getElementById('totalApplications').textContent = totalApps;
      document.getElementById('pendingApplications').textContent = pendingApps;
      document.getElementById('approvedApplications').textContent = approvedApps;
    }

    // Initialize admin panel with database data
    async function initializeAdminPanel() {
      try {
        console.log(' Starting admin panel initialization...');
        
        // Load critical data first
        console.log(' Loading applications...');
        await loadApplications();
        updateDashboardStats();
        
        // Load all other data in parallel for better performance
        console.log(' Loading all content modules in parallel...');
        const loadingPromises = [
          loadNewsList(),
          loadSliderList(), 
          loadSettings(),
          loadLeadershipList(),
          loadStudentLifeImages(),
          loadStudentLifeActivities(),
          loadTestimonialsList()
        ];
        
        // Wait for all to complete
        await Promise.allSettled(loadingPromises);
        
        console.log(' Admin panel initialized successfully!');
        showNotification('Admin panel loaded successfully! All modules ready.', 'success');
      } catch (error) {
        console.error(' Error initializing admin panel:', error);
        showNotification('Error loading admin panel: ' + error.message, 'error');
      }
    }

    // Fast refresh all tables function
    async function refreshAllTables() {
      console.log(' Refreshing all tables...');
      showNotification('Refreshing all content...', 'info', 2000);
      
      const refreshPromises = [
        loadTestimonialsList(),
        loadNewsList(),
        loadSliderList(),
        loadStudentLifeImages(),
        loadStudentLifeActivities(),
        loadNectaResults(),
        loadTestimonialsList(),
        loadApplications()
      ];
      
      try {
        await Promise.allSettled(refreshPromises);
        updateDashboardStats();
        showNotification('All content refreshed successfully!', 'success');
      } catch (error) {
        console.error('Error refreshing tables:', error);
        showNotification('Error refreshing content: ' + error.message, 'error');
      }
    }

    // Add refresh button functionality
    function addRefreshButton() {
      const refreshBtn = document.createElement('button');
      refreshBtn.innerHTML = '<ion-icon name="refresh"></ion-icon> Refresh All';
      refreshBtn.className = 'btn btn-secondary';
      refreshBtn.style.cssText = `
        position: fixed;
        bottom: 80px;
        right: 20px;
        z-index: 1000;
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      `;
      
      refreshBtn.onclick = refreshAllTables;
      document.body.appendChild(refreshBtn);
    }

    // Load applications on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize dashboard
      showSection('dashboard');
      initializeAdminPanel();
      addRefreshButton();
      
      // Update stats every time applications change
      const originalSetItem = localStorage.setItem;
      localStorage.setItem = function(key, value) {
        originalSetItem.call(this, key, value);
        if (key === 'applications') {
          updateDashboardStats();
        }
      };

      // Auto-refresh tables every 30 seconds for real-time updates
      setInterval(() => {
        console.log(' Auto-refreshing content...');
        refreshAllTables();
      }, 30000); // 30 seconds
    });

    // Image preview for slider
    document.getElementById('sliderImages').addEventListener('change', function(e) {
      const preview = document.getElementById('sliderPreview');
      preview.innerHTML = '';
      
      Array.from(e.target.files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const div = document.createElement('div');
          div.className = 'image-preview-item';
          div.innerHTML = `
            <img src="${e.target.result}" alt="Preview">
            <button type="button" class="remove-image" onclick="removePreview(this)">
              <ion-icon name="close"></ion-icon>
            </button>
          `;
          preview.appendChild(div);
        };
        reader.readAsDataURL(file);
      });
    });

    function removePreview(btn) {
      btn.parentElement.remove();
    }

    // Logout function
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('adminLoggedIn');
        localStorage.removeItem('adminUsername');
        window.location.href = 'login.html';
      }
    }

    // Mobile sidebar toggle
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
    }

    // Submit NECTA Form Function
    async function submitNectaForm() {
      try {
        console.log(' NECTA Form submission started...');
        showNotification('Processing NECTA results...', 'info', 3000);
        
        const form = document.getElementById('nectaResultsForm');
        if (!form) {
          showNotification('Form not found!', 'error');
          return;
        }
        
        const formData = new FormData(form);
        
        // Debug form data
        console.log(' Form data:');
        for (let [key, value] of formData.entries()) {
          console.log(`  ${key}: ${value}`);
        }
        
        // Validate required fields
        const examLevel = formData.get('exam_level');
        const year = formData.get('year');
        const title = formData.get('title');
        const resultsUrl = formData.get('results_url');
        const totalStudents = formData.get('total_students');
        
        if (!examLevel) {
          showNotification('Please select examination level', 'warning');
          return;
        }
        
        if (!year || year < 2020 || year > 2030) {
          showNotification('Please enter a valid year (2020-2030)', 'warning');
          return;
        }
        
        if (!title || title.trim() === '') {
          showNotification('Please enter results title', 'warning');
          return;
        }
        
        if (!resultsUrl || resultsUrl.trim() === '') {
          showNotification('Please enter results URL', 'warning');
          return;
        }
        
        if (!totalStudents || totalStudents < 1) {
          showNotification('Please enter valid number of students', 'warning');
          return;
        }
        
        // Prepare data
        const nectaData = {
          exam_level: examLevel,
          year: parseInt(year),
          title: title.trim(),
          results_url: resultsUrl.trim(),
          total_students: parseInt(totalStudents),
          pass_rate: parseFloat(formData.get('pass_rate')) || null,
          div_1: parseInt(formData.get('div_1')) || 0,
          div_2: parseInt(formData.get('div_2')) || 0,
          div_3: parseInt(formData.get('div_3')) || 0,
          div_4: parseInt(formData.get('div_4')) || 0,
          notes: formData.get('notes')?.trim() || ''
        };
        
        console.log(' Saving NECTA data:', nectaData);
        showNotification('Saving NECTA results...', 'info', 2000);
        
        const result = await DatabaseManager.saveNectaResults(nectaData);
        
        if (result.success) {
          showNotification(' NECTA results saved successfully!', 'success');
          form.reset();
          
          // Refresh table
          if (typeof loadNectaResults === 'function') {
            await loadNectaResults();
          }
          
          console.log(' NECTA results saved:', result.data);
        } else {
          console.error(' Failed to save:', result.error);
          showNotification(' Error: ' + result.error, 'error');
          
          // Check for table existence
          if (result.error.includes('relation') || result.error.includes('does not exist')) {
            showNotification(' Please create necta_results table first using SQL commands', 'warning', 8000);
          }
        }
      } catch (error) {
        console.error(' Submit error:', error);
        showNotification(' Error: ' + error.message, 'error');
      }
    }

    // Simple NECTA Test Function
    async function testNectaSubmission() {
      try {
        console.log(' Testing NECTA submission...');
        showNotification('Testing NECTA database insert...', 'info', 3000);
        
        const testData = {
          exam_level: 'form4',
          year: 2024,
          title: 'Test Form 4 Results 2024',
          results_url: 'https://necta.go.tz/results/2024/csee',
          total_students: 150,
          pass_rate: 85.5,
          div_1: 20,
          div_2: 35,
          div_3: 12,
          div_4: 0,
          notes: 'Test NECTA results entry'
        };
        
        console.log(' Test NECTA data:', testData);
        
        const result = await DatabaseManager.saveNectaResults(testData);
        
        if (result.success) {
          showNotification(' NECTA test insert successful!', 'success');
          console.log(' NECTA test successful:', result.data);
          
          // Refresh the table
          await loadNectaResults();
        } else {
          console.error(' NECTA test failed:', result.error);
          showNotification(' NECTA test failed: ' + result.error, 'error');
          
          if (result.error.includes('relation') || result.error.includes('does not exist')) {
            showNotification(' Table not found. Please create necta_results table using SQL commands.', 'warning', 8000);
          }
        }
      } catch (error) {
        console.error(' NECTA test error:', error);
        showNotification(' NECTA test error: ' + error.message, 'error');
      }
    }

    // Authentication check
    function checkAuthentication() {
      const isLoggedIn = localStorage.getItem('adminLoggedIn');
      const loginTime = localStorage.getItem('loginTime');
      const adminUsername = localStorage.getItem('adminUsername');
      
      console.log(' Checking authentication...', { isLoggedIn, loginTime, adminUsername });
      
      if (!isLoggedIn || isLoggedIn !== 'true' || !adminUsername) {
        console.log(' User not logged in, redirecting to login page');
        clearSession();
        window.location.href = 'login.html';
        return false;
      }
      
      // Check session timeout (8 hours for better security)
      if (loginTime) {
        const loginDate = new Date(loginTime);
        const now = new Date();
        const timeDiff = now - loginDate;
        const hoursDiff = timeDiff / (1000 * 60 * 60);
        
        if (hoursDiff > 8) {
          console.log(' Session expired, redirecting to login page');
          clearSession();
          window.location.href = 'login.html';
          return false;
        }
      } else {
        console.log(' No login time found, redirecting to login page');
        clearSession();
        window.location.href = 'login.html';
        return false;
      }
      
      // Update admin name in UI
      const adminNameEl = document.getElementById('adminName');
      if (adminNameEl && adminUsername) {
        adminNameEl.textContent = adminUsername;
      }
      
      console.log(' Authentication verified for user:', adminUsername);
      return true;
    }

    // Clear session data
    function clearSession() {
      localStorage.removeItem('adminLoggedIn');
      localStorage.removeItem('loginTime');
      localStorage.removeItem('adminUsername');
      localStorage.removeItem('adminEmail');
      localStorage.removeItem('adminRole');
    }

    // Logout function
    function logout() {
      console.log(' User logging out...');
      clearSession();
      window.location.href = 'login.html';
    }

    // Fix NECTA Form Submission
    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication first
      if (!checkAuthentication()) {
        return; // Will redirect to login
      }
      setTimeout(() => {
        const nectaForm = document.getElementById('nectaResultsForm');
        if (nectaForm) {
          console.log(' NECTA Form found, adding event listener');
          
          nectaForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log(' NECTA Form submitted!');
            
            try {
              const formData = new FormData(this);
              
              const nectaData = {
                exam_level: formData.get('exam_level'),
                year: parseInt(formData.get('year')),
                title: formData.get('title'),
                results_url: formData.get('results_url'),
                total_students: parseInt(formData.get('total_students')),
                pass_rate: parseFloat(formData.get('pass_rate')) || null,
                div_1: parseInt(formData.get('div_1')) || 0,
                div_2: parseInt(formData.get('div_2')) || 0,
                div_3: parseInt(formData.get('div_3')) || 0,
                div_4: parseInt(formData.get('div_4')) || 0,
                notes: formData.get('notes') || ''
              };
              
              console.log(' Saving NECTA data:', nectaData);
              showNotification('Saving NECTA results...', 'info', 2000);
              
              const result = await DatabaseManager.saveNectaResults(nectaData);
              
              if (result.success) {
                showNotification('NECTA results saved successfully!', 'success');
                this.reset();
                await loadNectaResults();
              } else {
                showNotification('Error: ' + result.error, 'error');
              }
            } catch (error) {
              console.error('Error:', error);
              showNotification('Error: ' + error.message, 'error');
            }
          });
        } else {
          console.error(' NECTA Form not found');
        }
      }, 1000);
    });

    // Auto refresh functionality for admin modules
    let autoRefreshInterval;
    let refreshCounter = 0;

    function startAutoRefresh() {
      console.log(' Starting auto refresh...');
      
      autoRefreshInterval = setInterval(async () => {
        refreshCounter++;
        console.log(` Auto refresh #${refreshCounter} - Loading fresh data...`);
        
        try {
          // Refresh dashboard statistics
          await refreshDashboardStats();
          
          // Refresh current section data
          const activeSection = document.querySelector('.content-section.active');
          if (activeSection) {
            const sectionId = activeSection.id;
            await refreshSectionData(sectionId);
          }
          
          console.log(' Auto refresh completed successfully');
        } catch (error) {
          console.error(' Auto refresh error:', error);
        }
      }, 30000); // Refresh every 30 seconds
    }

    async function refreshDashboardStats() {
      try {
        // Check if DatabaseManager exists
        if (typeof DatabaseManager === 'undefined') {
          console.log('DatabaseManager not available, skipping stats refresh');
          return;
        }

        // Refresh applications count
        const appsResult = await DatabaseManager.getApplications();
        if (appsResult && appsResult.success && appsResult.data) {
          const totalApps = appsResult.data.length || 0;
          const pendingApps = appsResult.data.filter(app => app.status === 'pending').length || 0;
          const approvedApps = appsResult.data.filter(app => app.status === 'approved').length || 0;
          
          // Safely update elements
          const totalEl = document.getElementById('totalApplications');
          const pendingEl = document.getElementById('pendingApplications');
          const approvedEl = document.getElementById('approvedApplications');
          
          if (totalEl) totalEl.textContent = totalApps;
          if (pendingEl) pendingEl.textContent = pendingApps;
          if (approvedEl) approvedEl.textContent = approvedApps;
        } else {
          console.log('No application data available or error occurred');
        }
      } catch (error) {
        console.error('Error refreshing dashboard stats:', error);
        // Don't show error to user, just log it
      }
    }

    async function refreshSectionData(sectionId) {
      try {
        switch(sectionId) {
          case 'section-applications':
            if (typeof loadApplications === 'function') {
              await loadApplications();
            } else {
              console.log('loadApplications function not available');
            }
            break;
          case 'section-news':
            if (typeof loadNews === 'function') {
              await loadNews();
            } else {
              console.log('loadNews function not available');
            }
            break;
          case 'section-necta-results':
            if (typeof loadNectaResults === 'function') {
              await loadNectaResults();
            } else {
              console.log('loadNectaResults function not available');
            }
            break;
          default:
            console.log('No specific refresh for section:', sectionId);
        }
      } catch (error) {
        console.error('Error refreshing section data:', error);
        // Don't show error to user, just log it
      }
    }

    function stopAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        console.log(' Auto refresh stopped');
      }
    }

    // Manual refresh button functionality
    function manualRefresh() {
      console.log(' Manual refresh triggered...');
      
      try {
        refreshDashboardStats();
        const activeSection = document.querySelector('.content-section.active');
        if (activeSection) {
          refreshSectionData(activeSection.id);
        }
        
        // Only show success notification if showNotification function exists
        if (typeof showNotification === 'function') {
          showNotification('Data refreshed successfully!', 'success', 2000);
        } else {
          console.log(' Manual refresh completed');
        }
      } catch (error) {
        console.error('Error during manual refresh:', error);
        // Don't show error to user
      }
    }

    // Start auto refresh when page loads
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        startAutoRefresh();
      }, 5000); // Start after 5 seconds
    });

    // Stop auto refresh when page is hidden/minimized
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        stopAutoRefresh();
      } else {
        startAutoRefresh();
      }
    });

    // Mobile menu toggle functionality
    function toggleMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('active');
    }

    // Close mobile menu when clicking outside
    document.addEventListener('click', function(event) {
      const sidebar = document.getElementById('sidebar');
      const mobileToggle = document.querySelector('.mobile-toggle');
      
      if (window.innerWidth <= 768 && 
          sidebar.classList.contains('active') && 
          !sidebar.contains(event.target) && 
          !mobileToggle.contains(event.target)) {
        sidebar.classList.remove('active');
      }
    });

    // Close mobile menu when window is resized to desktop
    window.addEventListener('resize', function() {
      const sidebar = document.getElementById('sidebar');
      if (window.innerWidth > 768) {
        sidebar.classList.remove('active');
      }
    });

  </script>
</body>

</html>
